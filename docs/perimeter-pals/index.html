<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>üèóÔ∏è Perimeter Pals</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --sky:#E8F4FD;--grass:#7BC67E;--sun:#FFD93D;--brick:#E07B5A;
  --blue:#4BAFD6;--purple:#9B7FD4;--pink:#F06292;
  --green:#5CB85C;--red:#E05555;--orange:#FF8C42;
  --white:#FFFEF5;--dark:#3D2B1F;--mid:#7A6055;
  --card:#FFFEF5;--shadow:rgba(61,43,31,0.15);--xp:#FFB347;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;}
body{font-family:'Nunito',sans-serif;background:var(--sky);display:flex;flex-direction:column;align-items:center;
  background-image:radial-gradient(ellipse at 80% 10%,#fffbe6 0%,transparent 40%),
  radial-gradient(ellipse at 20% 90%,#d4f0d4 0%,transparent 40%);overflow:hidden;}

.screen{display:none;flex-direction:column;align-items:center;width:100%;height:100%;overflow-y:auto;padding-bottom:32px;}
.screen.active{display:flex;animation:popIn .28s ease;}
@keyframes popIn{from{opacity:0;transform:scale(.95) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}

/* HOME */
#homeScreen{justify-content:flex-start;padding:18px 18px 28px;}
.home-wrap{max-width:460px;width:100%;display:flex;flex-direction:column;align-items:center;}
.builder-img{font-size:4rem;margin:4px 0 8px;animation:bounce 2.2s ease-in-out infinite;}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.home-title{font-family:'Baloo 2',cursive;font-size:clamp(1.9rem,7vw,3.4rem);color:var(--dark);text-align:center;line-height:1.05;margin-bottom:2px;}
.home-title span{color:var(--brick);}
.home-sub{font-size:.92rem;color:var(--mid);font-weight:700;text-align:center;margin-bottom:16px;}

.xp-bar-wrap{width:100%;background:white;border-radius:18px;padding:12px 16px;margin-bottom:14px;border:2px solid #f0e8dc;box-shadow:0 4px 14px var(--shadow);}
.xp-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.xp-level{font-family:'Baloo 2',cursive;font-size:.95rem;color:var(--dark);}
.xp-lbl{font-size:.75rem;font-weight:800;color:var(--mid);}
.xp-track{width:100%;height:12px;background:#f0e8dc;border-radius:99px;overflow:hidden;}
.xp-fill{height:100%;background:linear-gradient(90deg,var(--xp),var(--brick));border-radius:99px;transition:width .6s cubic-bezier(.34,1.56,.64,1);}
.streak-badge{display:flex;align-items:center;gap:5px;margin-top:7px;font-size:.88rem;font-weight:700;color:var(--mid);}

.mode-grid{display:grid;grid-template-columns:1fr;gap:11px;width:100%;}
.mode-btn{background:var(--card);border-radius:20px;padding:16px 18px;display:flex;align-items:center;gap:14px;border:3px solid transparent;box-shadow:0 5px 18px var(--shadow);cursor:pointer;transition:all .18s;text-align:left;-webkit-user-select:none;user-select:none;}
.mode-btn:active{transform:scale(.97);}
.mode-btn.learn{border-color:#4BAFD6;}.mode-btn.try{border-color:#E07B5A;}.mode-btn.explore{border-color:#9B7FD4;}
.mode-emoji{font-size:2.4rem;flex-shrink:0;}
.mode-name{font-family:'Baloo 2',cursive;font-size:1.25rem;color:var(--dark);line-height:1.1;}
.mode-desc{font-size:.8rem;color:var(--mid);font-weight:700;line-height:1.4;margin-top:1px;}
.mode-tag{display:inline-block;padding:2px 9px;border-radius:99px;font-size:.68rem;font-weight:800;color:white;margin-top:4px;}
.tag-blue{background:var(--blue);}.tag-orange{background:var(--brick);}.tag-purple{background:var(--purple);}

/* HEADER */
.page-header{width:100%;max-width:680px;display:flex;align-items:center;justify-content:center;padding:13px 14px 3px;position:relative;flex-shrink:0;}
.page-title{font-family:'Baloo 2',cursive;font-size:clamp(1.25rem,4vw,1.85rem);color:var(--dark);text-align:center;}
.back-btn{position:absolute;left:14px;background:white;border:2px solid #e0d8cc;border-radius:99px;padding:7px 13px;font-family:'Nunito',sans-serif;font-weight:800;font-size:.82rem;color:var(--mid);cursor:pointer;transition:all .15s;}
.back-btn:active{background:#fff3d6;color:var(--brick);}

/* LEARN */
#learnScreen{padding:0 0 22px;}
.learn-wrap{width:100%;max-width:580px;padding:0 13px;}
.step-dots{display:flex;gap:6px;justify-content:center;margin:7px 0 11px;flex-wrap:wrap;}
.step-dot{width:8px;height:8px;border-radius:50%;background:#e0d8cc;transition:all .3s;flex-shrink:0;}
.step-dot.active{background:var(--brick);transform:scale(1.35);}
.step-dot.done{background:var(--green);}

.lesson-card{background:var(--card);border-radius:20px;padding:20px;margin-bottom:11px;box-shadow:0 5px 20px var(--shadow);border:3px solid #f0e8dc;}
.lesson-card h2{font-family:'Baloo 2',cursive;font-size:1.35rem;color:var(--dark);margin-bottom:7px;}
.story-box{background:#fff8ee;border-left:4px solid var(--sun);border-radius:11px;padding:11px 14px;margin:10px 0;font-size:.93rem;color:var(--dark);font-weight:600;line-height:1.65;}
.info-box{background:#f0f8ff;border-left:4px solid var(--blue);border-radius:11px;padding:11px 14px;margin:10px 0;font-size:.9rem;color:var(--dark);font-weight:600;line-height:1.65;}
.compare-box{background:#f5f0ff;border-left:4px solid var(--purple);border-radius:11px;padding:11px 14px;margin:10px 0;font-size:.9rem;color:var(--dark);font-weight:600;line-height:1.65;}

.shape-demo{display:flex;justify-content:center;gap:20px;flex-wrap:wrap;margin:12px 0;}
.addition-row{display:flex;align-items:center;flex-wrap:wrap;gap:6px;justify-content:center;margin:11px 0;}
.add-chip{background:#f0f8ff;border:2px solid var(--blue);border-radius:9px;padding:6px 12px;font-family:'Baloo 2',cursive;font-size:1rem;color:var(--dark);transition:all .4s;}
.add-chip.active{background:var(--blue);color:white;transform:scale(1.08);}
.add-plus,.add-equals{font-size:1rem;color:var(--mid);font-weight:800;}
.add-total{background:var(--green);color:white;border:none;padding:6px 13px;border-radius:9px;font-family:'Baloo 2',cursive;font-size:1rem;transition:opacity .4s;}

.walk-demo{position:relative;display:flex;justify-content:center;margin:10px 0;}
.step-counter{display:flex;gap:4px;flex-wrap:wrap;justify-content:center;margin:8px 0;}
.step-sq{width:34px;height:34px;border-radius:8px;border:2px solid #e0d8cc;background:white;display:flex;align-items:center;justify-content:center;font-family:'Baloo 2',cursive;font-size:.85rem;color:var(--dark);transition:all .3s;}
.step-sq.hop{background:var(--brick);color:white;transform:scale(1.18);}
.step-sq.done{background:var(--green);color:white;}

.guess-tool{background:#fff8ee;border:2px solid var(--sun);border-radius:14px;padding:13px;margin-top:10px;}
.guess-title{font-size:.76rem;font-weight:800;color:var(--mid);text-transform:uppercase;letter-spacing:.5px;margin-bottom:9px;}
.guess-row{display:flex;align-items:center;gap:5px;flex-wrap:wrap;margin-bottom:7px;}
.g-chip{background:white;border:2px solid var(--sun);border-radius:8px;padding:6px 10px;font-family:'Baloo 2',cursive;font-size:.93rem;color:var(--dark);min-width:38px;text-align:center;}
.g-chip.v{background:var(--sun);}
.g-chip.s{background:var(--orange);color:white;border-color:var(--orange);}
.g-chip.s.ok{background:var(--green);}
.g-chip.s.ov{background:var(--red);}
.g-inp{width:52px;border:2px solid var(--purple);border-radius:8px;padding:7px;font-family:'Baloo 2',cursive;font-size:1rem;text-align:center;color:var(--dark);outline:none;}
.g-btn{background:var(--purple);color:white;border:none;border-radius:99px;padding:7px 15px;font-family:'Baloo 2',cursive;font-size:.86rem;cursor:pointer;transition:all .15s;}
.g-btn:active{transform:scale(.95);}
.g-fb{font-family:'Baloo 2',cursive;font-size:.9rem;margin-top:7px;min-height:20px;}

.nl-wrap{overflow-x:auto;padding:5px 0;}
.nl-inner{display:flex;align-items:center;gap:0;min-width:max-content;padding:0 5px;}
.nl-num{width:38px;height:38px;border-radius:50%;border:2px solid #e0d8cc;background:white;display:flex;align-items:center;justify-content:center;font-family:'Baloo 2',cursive;font-size:.9rem;color:var(--dark);cursor:pointer;transition:all .18s;flex-shrink:0;}
.nl-num:active{transform:scale(.88);}
.nl-num.marked{background:var(--blue);color:white;border-color:var(--blue);}
.nl-num.hop{background:var(--brick);color:white;border-color:var(--brick);transform:scale(1.25);}
.nl-dash{width:5px;height:2px;background:#e0d8cc;flex-shrink:0;}

.lesson-nav{display:flex;gap:9px;justify-content:center;margin-top:11px;}
.lesson-btn{background:var(--brick);color:white;border:none;border-radius:99px;padding:12px 28px;font-family:'Baloo 2',cursive;font-size:1rem;cursor:pointer;transition:all .15s;box-shadow:0 4px 10px rgba(224,123,90,.3);}
.lesson-btn:active{transform:scale(.96);}
.lesson-btn.sec{background:#f0e8dc;color:var(--mid);box-shadow:none;}

/* TRY */
#tryScreen{padding:0 0 22px;}
.try-wrap{width:100%;max-width:580px;padding:0 13px;}
.xp-hud{background:var(--dark);border-radius:14px;padding:9px 15px;margin:7px 0 11px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.hud-level{font-family:'Baloo 2',cursive;font-size:.9rem;color:var(--sun);white-space:nowrap;}
.hud-track{flex:1;min-width:60px;height:9px;background:rgba(255,255,255,.15);border-radius:99px;overflow:hidden;}
.hud-fill{height:100%;background:linear-gradient(90deg,var(--xp),var(--brick));border-radius:99px;transition:width .5s cubic-bezier(.34,1.56,.64,1);}
.hud-xp{font-size:.75rem;color:rgba(255,255,255,.5);font-weight:700;white-space:nowrap;}
.hud-streak{font-family:'Baloo 2',cursive;font-size:.95rem;white-space:nowrap;}

.ch-card{background:var(--card);border-radius:20px;padding:18px;box-shadow:0 5px 20px var(--shadow);border:3px solid #f0e8dc;margin-bottom:11px;}
.ch-badge{display:inline-block;padding:3px 11px;border-radius:99px;font-size:.72rem;font-weight:800;color:white;margin-bottom:7px;}
.badge-find{background:var(--blue);}.badge-word{background:var(--green);}.badge-equal{background:var(--purple);}.badge-match{background:var(--orange);}
.ch-q{font-family:'Baloo 2',cursive;font-size:1.15rem;color:var(--dark);margin-bottom:12px;line-height:1.45;}
.shape-display{display:flex;justify-content:center;align-items:flex-start;gap:14px;margin:10px 0;flex-wrap:wrap;}
.shape-label{font-family:'Baloo 2',cursive;font-size:.82rem;color:var(--mid);text-align:center;margin-top:4px;}

.est-wrap{background:#fff8ee;border:2px solid var(--sun);border-radius:13px;padding:12px;margin-top:9px;}
.est-title{font-size:.74rem;font-weight:800;color:var(--mid);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;}
.est-chips{display:flex;align-items:center;gap:5px;flex-wrap:wrap;margin-bottom:7px;}
.est-chip{background:white;border:2px solid var(--sun);border-radius:8px;padding:5px 10px;font-family:'Baloo 2',cursive;font-size:.9rem;color:var(--dark);min-width:36px;text-align:center;}
.est-chip.v{background:var(--sun);}
.est-chip.s{background:var(--orange);color:white;border-color:var(--orange);}
.est-chip.s.ok{background:var(--green);}
.est-chip.s.ov{background:var(--red);}
.est-row{display:flex;align-items:center;gap:7px;flex-wrap:wrap;}
.est-inp{width:55px;border:2px solid var(--purple);border-radius:8px;padding:7px;font-family:'Baloo 2',cursive;font-size:1rem;text-align:center;color:var(--dark);outline:none;}
.est-btn{background:var(--purple);color:white;border:none;border-radius:99px;padding:8px 16px;font-family:'Baloo 2',cursive;font-size:.86rem;cursor:pointer;transition:all .15s;}
.est-btn:active{transform:scale(.95);}
.est-fb{font-family:'Baloo 2',cursive;font-size:.88rem;margin-top:6px;min-height:18px;}

.ans-section{display:flex;flex-direction:column;align-items:center;gap:9px;margin-top:13px;}
.ans-lbl{font-size:.83rem;font-weight:800;color:var(--mid);}
.ans-row{display:flex;align-items:center;gap:9px;}
.ans-inp{width:86px;border:3px solid #e0d8cc;border-radius:13px;padding:10px;font-family:'Baloo 2',cursive;font-size:1.45rem;text-align:center;color:var(--dark);outline:none;transition:border-color .2s;}
.ans-inp:focus{border-color:var(--blue);}
.ans-inp.ok{border-color:var(--green);background:#f0fff3;}
.ans-inp.no{border-color:var(--red);background:#fff0f3;}
.ans-unit{font-family:'Baloo 2',cursive;font-size:1.05rem;color:var(--mid);}
.check-btn{background:var(--brick);color:white;border:none;border-radius:99px;padding:12px 24px;font-family:'Baloo 2',cursive;font-size:1rem;cursor:pointer;transition:all .15s;box-shadow:0 4px 10px rgba(224,123,90,.3);}
.check-btn:active{transform:scale(.96);}
.check-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.try-fb{font-family:'Baloo 2',cursive;font-size:1.05rem;text-align:center;min-height:26px;}
.try-fb.ok{color:var(--green);}.try-fb.no{color:var(--red);}.try-fb.hint{color:var(--blue);}
.next-btn{background:var(--green);color:white;border:none;border-radius:99px;padding:12px 32px;font-family:'Baloo 2',cursive;font-size:1.05rem;cursor:pointer;transition:all .15s;box-shadow:0 4px 10px rgba(92,184,92,.3);}
.next-btn:active{transform:scale(.96);}

/* EXPLORE */
#exploreScreen{padding:0 0 22px;}
.explore-wrap{width:100%;max-width:660px;padding:0 13px;}
.shape-sel{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:9px 0;}
.ss-btn{background:white;border:3px solid #e0d8cc;border-radius:13px;padding:9px 12px;font-family:'Baloo 2',cursive;font-size:.84rem;color:var(--mid);cursor:pointer;transition:all .18s;display:flex;flex-direction:column;align-items:center;gap:2px;min-width:68px;}
.ss-btn:active{transform:scale(.94);}
.ss-btn.active{border-color:var(--purple);background:#f5f0ff;color:var(--purple);}
.ss-icon{font-size:1.6rem;}

.exp-canvas{background:white;border-radius:18px;box-shadow:0 5px 20px var(--shadow);border:3px solid #f0e8dc;display:flex;justify-content:center;align-items:center;min-height:200px;margin:9px 0;padding:12px;overflow:hidden;}



.perim-display{background:var(--dark);color:var(--sun);border-radius:14px;padding:11px 20px;text-align:center;margin:5px 0;}
.perim-lbl{font-size:.74rem;font-weight:800;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.5px;}
.perim-val{font-family:'Baloo 2',cursive;font-size:1.8rem;color:var(--sun);}
.perim-unit{font-size:.9rem;color:rgba(255,255,255,.45);margin-left:3px;}
.add-display{font-family:'Baloo 2',cursive;font-size:.82rem;color:rgba(255,255,255,.5);margin-top:1px;}

.sliders-wrap{display:flex;flex-direction:column;gap:9px;margin:7px 0;}
.sl-card{background:white;border-radius:13px;padding:11px 13px;border:2px solid #f0e8dc;box-shadow:0 2px 7px var(--shadow);}
.sl-lbl{font-size:.75rem;font-weight:800;color:var(--mid);text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px;display:flex;justify-content:space-between;}
.sl-val{color:var(--brick);font-family:'Baloo 2',cursive;font-size:.92rem;}
input[type=range]{width:100%;height:5px;border-radius:99px;accent-color:var(--brick);cursor:pointer;}
.unit-row{display:flex;gap:7px;flex-wrap:wrap;margin:5px 0;}
.unit-btn{padding:7px 14px;border-radius:99px;border:2px solid #e0d8cc;background:white;color:var(--mid);font-family:'Baloo 2',cursive;font-size:.84rem;cursor:pointer;transition:all .15s;}
.unit-btn.active{border-color:var(--brick);background:var(--brick);color:white;}
.exp-facts{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:7px;}
.fact-chip{background:white;border:2px solid #e8e0d4;border-radius:10px;padding:6px 12px;font-size:.78rem;font-weight:700;color:var(--mid);box-shadow:0 2px 5px var(--shadow);}
.fact-chip strong{color:var(--dark);}

/* CELEBRATION */
.celeb-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:center;justify-content:center;animation:fadeIn .25s ease;padding:14px;}
.celeb-overlay.hidden{display:none;}
.celeb-card{background:var(--card);border-radius:26px;padding:28px 24px;max-width:350px;width:100%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.25);border:3px solid var(--sun);animation:popIn .32s ease;}
.celeb-emoji{font-size:3.5rem;display:block;margin-bottom:8px;}
.celeb-title{font-family:'Baloo 2',cursive;font-size:1.75rem;color:var(--dark);margin-bottom:3px;}
.celeb-xp{font-family:'Baloo 2',cursive;font-size:1.05rem;color:var(--brick);margin-bottom:5px;}
.celeb-streak{font-family:'Baloo 2',cursive;font-size:.92rem;margin-bottom:8px;min-height:22px;}
.celeb-msg{font-size:.9rem;color:var(--mid);font-weight:600;line-height:1.5;margin-bottom:16px;}
.celeb-btn{background:var(--brick);color:white;border:none;border-radius:99px;padding:13px 32px;font-family:'Baloo 2',cursive;font-size:1.1rem;cursor:pointer;transition:all .15s;box-shadow:0 4px 14px rgba(224,123,90,.3);}
.celeb-btn:active{transform:scale(.96);}
.lvl-flash{position:fixed;inset:0;background:rgba(255,211,61,.35);z-index:199;pointer-events:none;animation:lvlF .6s ease forwards;}
@keyframes lvlF{0%{opacity:0}30%{opacity:1}100%{opacity:0}}
.confetti-piece{position:fixed;border-radius:2px;animation:cFall linear forwards;pointer-events:none;z-index:201;}
@keyframes cFall{0%{transform:translateY(-20px) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.hidden{display:none!important;}
@supports(padding:max(0px)){body{padding-bottom:env(safe-area-inset-bottom);}}
</style>
</head>
<body>

<div class="celeb-overlay hidden" id="celebration">
  <div class="celeb-card">
    <span class="celeb-emoji" id="cEmoji">üéâ</span>
    <div class="celeb-title" id="cTitle">Amazing!</div>
    <div class="celeb-xp" id="cXp">+10 XP</div>
    <div class="celeb-streak" id="cStreak"></div>
    <div class="celeb-msg" id="cMsg">You got it!</div>
    <button class="celeb-btn" onclick="celebNext()">Next Challenge ‚Üí</button>
  </div>
</div>

<!-- HOME -->
<div id="homeScreen" class="screen active">
  <div class="home-wrap">
    <div class="builder-img">üèóÔ∏è</div>
    <div class="home-title">Perimeter<br><span>Pals!</span></div>
    <div class="home-sub">Build it. Measure it. Learn it!</div>
    <div class="xp-bar-wrap">
      <div class="xp-top">
        <div class="xp-level" id="homeLvl">üß± Apprentice Builder</div>
        <div class="xp-lbl" id="homeXpLbl">0 / 50 XP</div>
      </div>
      <div class="xp-track"><div class="xp-fill" id="homeXpFill" style="width:0%"></div></div>
      <div class="streak-badge"><span id="homeStreakIcon">üí§</span><span id="homeStreakLbl" style="margin-left:4px;">No streak yet ‚Äî start playing!</span></div>
    </div>
    <div class="mode-grid">
      <div class="mode-btn learn" onclick="showLearn()"><div class="mode-emoji">üìñ</div><div><div class="mode-name">Learn</div><div class="mode-desc">Discover perimeter with stories and shapes!</div><span class="mode-tag tag-blue">Start here!</span></div></div>
      <div class="mode-btn try" onclick="showTry()"><div class="mode-emoji">üéØ</div><div><div class="mode-name">Try It</div><div class="mode-desc">Solve challenges, earn XP and build your streak!</div><span class="mode-tag tag-orange">Earn XP!</span></div></div>
      <div class="mode-btn explore" onclick="showExplore()"><div class="mode-emoji">üî≠</div><div><div class="mode-name">Explore</div><div class="mode-desc">Build shapes and watch the perimeter change live!</div><span class="mode-tag tag-purple">Free play!</span></div></div>
    </div>
  </div>
</div>

<!-- LEARN -->
<div id="learnScreen" class="screen">
  <div class="page-header"><button class="back-btn" onclick="goHome()">‚Üê Home</button><div class="page-title">üìñ Learn</div></div>
  <div class="learn-wrap"><div class="step-dots" id="learnDots"></div><div id="learnContent"></div></div>
</div>

<!-- TRY -->
<div id="tryScreen" class="screen">
  <div class="page-header"><button class="back-btn" onclick="goHome()">‚Üê Home</button><div class="page-title">üéØ Try It</div></div>
  <div class="try-wrap">
    <div class="xp-hud">
      <div class="hud-level" id="hudLvl">üß± Apprentice</div>
      <div class="hud-track"><div class="hud-fill" id="hudFill" style="width:0%"></div></div>
      <div class="hud-xp" id="hudXp">0 XP</div>
      <div class="hud-streak" id="hudStreak">üí§ 0</div>
    </div>
    <div id="challengeContent"></div>
  </div>
</div>

<!-- EXPLORE -->
<div id="exploreScreen" class="screen">
  <div class="page-header"><button class="back-btn" onclick="goHome()">‚Üê Home</button><div class="page-title">üî≠ Explore</div></div>
  <div class="explore-wrap">
    <div class="shape-sel" id="shapeSel"></div>
    <div class="exp-canvas"><svg id="expSvg" width="260" height="210" viewBox="0 0 260 210"></svg></div>
    <div class="perim-display">
      <div class="perim-lbl">Perimeter</div>
      <div><span class="perim-val" id="perimVal">0</span><span class="perim-unit" id="perimUnit"> ft</span></div>
      <div class="add-display" id="addDisplay"></div>
    </div>
    <div class="sliders-wrap" id="slidersWrap"></div>
    <div class="unit-row" id="unitRow"></div>
    <div class="exp-facts" id="expFacts"></div>
  </div>
</div>

<script>
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHAPE DRAWING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SC={
  square:   {fill:'#B8E4F9',stroke:'#4BAFD6'},
  rectangle:{fill:'#FFE0B2',stroke:'#E07B5A'},
  triangle: {fill:'#C8F0C8',stroke:'#5CB85C'},
  pentagon: {fill:'#E8D5F5',stroke:'#9B7FD4'},
  hexagon:  {fill:'#FFE8D0',stroke:'#FF8C42'},
};

// Fixed layout for challenges/learn ‚Äî always fits nicely
function getPoints(shape,W,H){
  const cx=W/2,cy=H/2,r=Math.min(W,H)*0.33;
  if(shape==='rectangle'){const w=r*2.0,h=r*1.1;return[[cx-w/2,cy-h/2],[cx+w/2,cy-h/2],[cx+w/2,cy+h/2],[cx-w/2,cy+h/2]];}
  if(shape==='square'){const s=r*1.55;return[[cx-s/2,cy-s/2],[cx+s/2,cy-s/2],[cx+s/2,cy+s/2],[cx-s/2,cy+s/2]];}
  const n={triangle:3,pentagon:5,hexagon:6}[shape]||4;
  const rot=shape==='triangle'?-Math.PI/2:shape==='hexagon'?-Math.PI/2+Math.PI/6:-Math.PI/2;
  return Array.from({length:n},(_,i)=>[cx+r*Math.cos(rot+2*Math.PI*i/n),cy+r*Math.sin(rot+2*Math.PI*i/n)]);
}

// Value-driven layout for explore ‚Äî shape scales to reflect actual side lengths
function getPointsForExplore(shape,W,H,vals){
  const cx=W/2,cy=H/2;
  const PAD=38; // padding so labels don't clip

  if(shape==='square'||shape==='rectangle'){
    // vals[0]=top/bottom, vals[1]=left/right (rectangle) or all same (square)
    const rawW=vals[0], rawH=(shape==='rectangle'?vals[1]:vals[0]);
    // scale so the larger dimension fills the available space
    const maxDim=Math.max(rawW,rawH);
    const availW=W-PAD*2, availH=H-PAD*2;
    const scale=Math.min(availW/maxDim, availH/maxDim, 10); // cap scale
    const pw=rawW*scale, ph=rawH*scale;
    return[[cx-pw/2,cy-ph/2],[cx+pw/2,cy-ph/2],[cx+pw/2,cy+ph/2],[cx-pw/2,cy+ph/2]];
  }

  // For regular polygons, all sides equal ‚Äî scale by side length
  const n={triangle:3,pentagon:5,hexagon:6}[shape]||4;
  const s=vals[0]; // all sides same
  // circumradius from side length: r = s / (2 * sin(œÄ/n))
  const rawR=s/(2*Math.sin(Math.PI/n));
  const maxR=(Math.min(W,H)/2)-PAD;
  const minR=18;
  // map rawR to screen: side 1‚ÜíminR, side 20‚ÜímaxR
  const r=minR+(rawR/((20)/(2*Math.sin(Math.PI/n))))*(maxR-minR);
  const clampedR=Math.max(minR,Math.min(maxR,r));
  const rot=shape==='triangle'?-Math.PI/2:shape==='hexagon'?-Math.PI/2+Math.PI/6:-Math.PI/2;
  return Array.from({length:n},(_,i)=>[cx+clampedR*Math.cos(rot+2*Math.PI*i/n),cy+clampedR*Math.sin(rot+2*Math.PI*i/n)]);
}

function drawShape(svgEl,shape,labels,_unused,highlightIdx=-1){
  svgEl.innerHTML='';
  const W=+svgEl.getAttribute('width'),H=+svgEl.getAttribute('height');
  const pts=getPoints(shape,W,H);
  const c=SC[shape]||SC.square;

  const poly=document.createElementNS('http://www.w3.org/2000/svg','polygon');
  poly.setAttribute('points',pts.map(p=>p.join(',')).join(' '));
  poly.setAttribute('fill',c.fill);
  poly.setAttribute('stroke',c.stroke);
  poly.setAttribute('stroke-width','3');
  svgEl.appendChild(poly);

  if(!labels||!labels.length) return;
  const cx=W/2,cy=H/2;
  labels.forEach((lbl,i)=>{
    if(lbl===null||lbl===undefined) return;
    const a=pts[i],b=pts[(i+1)%pts.length];
    const mx=(a[0]+b[0])/2,my=(a[1]+b[1])/2;
    const dx=mx-cx,dy=my-cy,dist=Math.sqrt(dx*dx+dy*dy)||1;
    const ox=mx+dx/dist*26,oy=my+dy/dist*24;
    const isHL=i===highlightIdx;
    const tw=Math.max(34,String(lbl).length*8+14);
    const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
    const txt=document.createElementNS('http://www.w3.org/2000/svg','text');
    rect.setAttribute('x',ox-tw/2);rect.setAttribute('y',oy-12);rect.setAttribute('width',tw);rect.setAttribute('height','24');rect.setAttribute('rx','6');
    rect.setAttribute('fill',isHL?c.stroke:'#FFD93D');rect.setAttribute('stroke',isHL?'white':c.stroke);rect.setAttribute('stroke-width','1.5');
    txt.setAttribute('x',ox);txt.setAttribute('y',oy+4);txt.setAttribute('text-anchor','middle');
    txt.setAttribute('font-family','Baloo 2, cursive');txt.setAttribute('font-size','11');txt.setAttribute('font-weight','700');
    txt.setAttribute('fill',isHL?'white':'#3D2B1F');txt.textContent=String(lbl);
    g.appendChild(rect);g.appendChild(txt);svgEl.appendChild(g);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// XP / STREAK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LEVELS=[
  {min:0,   max:50,  title:'üß± Apprentice Builder'},
  {min:50,  max:130, title:'ü™ö Junior Builder'},
  {min:130, max:250, title:'üè† Builder'},
  {min:250, max:420, title:'üèóÔ∏è Senior Builder'},
  {min:420, max:650, title:'üè∞ Master Builder'},
  {min:650, max:950, title:'‚ö° Architect'},
  {min:950, max:1300,title:'üåü Grand Architect'},
  {min:1300,max:9999,title:'üèÜ Perimeter Legend'},
];
let xp=0,streak=0;

function getLv(){for(let i=LEVELS.length-1;i>=0;i--)if(xp>=LEVELS[i].min)return{...LEVELS[i],idx:i};return{...LEVELS[0],idx:0};}
function addXP(n){const p=getLv();xp+=n;const nl=getLv();updateHUD();updateHomeXP();return nl.idx>p.idx;}
function getSD(){
  if(streak>=10)return{icon:'üåã',lbl:'VOLCANO'};
  if(streak>=7) return{icon:'‚òÑÔ∏è', lbl:'METEOR'};
  if(streak>=5) return{icon:'üî•',lbl:'INFERNO'};
  if(streak>=3) return{icon:'üî•',lbl:'ON FIRE'};
  if(streak>=2) return{icon:'‚ú®',lbl:'Hot streak'};
  if(streak===1)return{icon:'‚≠ê',lbl:'Going!'};
  return{icon:'üí§',lbl:''};
}
function earnXP(correct){
  if(!correct){streak=0;updateHUD();updateHomeXP();return 0;}
  streak++;
  const bonus=streak>=10?5:streak>=7?4:streak>=5?3:streak>=3?2:1;
  return 10*bonus;
}
function updateHUD(){
  const lv=getLv(),pct=Math.min(100,Math.round((xp-lv.min)/(lv.max-lv.min)*100));
  document.getElementById('hudLvl').textContent=lv.title;
  document.getElementById('hudFill').style.width=pct+'%';
  document.getElementById('hudXp').textContent=xp+' XP';
  const sd=getSD();
  document.getElementById('hudStreak').textContent=sd.icon+' '+streak;
}
function updateHomeXP(){
  const lv=getLv(),pct=Math.min(100,Math.round((xp-lv.min)/(lv.max-lv.min)*100));
  document.getElementById('homeLvl').textContent=lv.title;
  document.getElementById('homeXpLbl').textContent=xp+' / '+lv.max+' XP';
  document.getElementById('homeXpFill').style.width=pct+'%';
  const sd=getSD();
  document.getElementById('homeStreakIcon').textContent=sd.icon;
  document.getElementById('homeStreakLbl').textContent=
    streak===0?'No streak yet ‚Äî start playing!':
    streak===1?'1 in a row ‚Äî keep going!':
    sd.lbl+' ‚Äî '+streak+' in a row!';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');window.scrollTo(0,0);}
function goHome(){showScreen('homeScreen');updateHomeXP();}
window.goHome=goHome;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEARN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lStep=0,nlAnimGoing=false;

const LESSONS=[
  {
    title:"What Is Perimeter?",
    story:"Imagine you have a garden and you want to put a little fence ALL THE WAY AROUND the outside of it. The total length of that fence is called the <strong>perimeter</strong>! üåª",
    shape:'square',sides:[5,5,5,5],unit:'ft',anim:'walk',
    explain:"Perimeter = the distance around the OUTSIDE of a shape. Like walking all the way around the edge and counting every step!"
  },
  {
    title:"Squares: 4 Equal Sides",
    story:"A square is special ‚Äî all 4 sides are EXACTLY the same length. If one side is 5 ft, they ALL must be 5 ft. Let's add them up! üü¶",
    shape:'square',sides:[5,5,5,5],unit:'ft',anim:'add',sum:20,
    explain:"5 + 5 + 5 + 5 = <strong>20 ft</strong>. All four sides are equal!"
  },
  {
    title:"Hop on the Number Line!",
    story:"A number line is like a ruler you can hop on! ü¶ò Start at 0, hop the length of the first side, then keep hopping. Let's add 5+5+5+5 by hopping!",
    shape:'square',sides:[5,5,5,5],unit:'ft',anim:'numberline',sum:20,hops:[5,5,5,5],
    explain:"Hop +5 ‚Üí 5. Hop +5 ‚Üí 10. Hop +5 ‚Üí 15. Hop +5 ‚Üí 20! Perimeter = <strong>20 ft</strong>"
  },
  {
    title:"Rectangles: 2 Pairs of Sides",
    story:"A rectangle is like a stretched square. The <strong>top and bottom are the same</strong>, and the <strong>left and right are the same</strong> ‚Äî but those two pairs can be different lengths. üì¶",
    shape:'rectangle',sides:[8,4,8,4],unit:'ft',anim:'add',sum:24,
    explain:"Top(8) + Right(4) + Bottom(8) + Left(4) = <strong>24 ft</strong>. The opposite sides always match!"
  },
  {
    title:"Triangles: 3 Sides",
    story:"Jake is building a triangular sandbox. Each side is 7 ft long. How much wood does he need to go all the way around? üèñÔ∏è",
    shape:'triangle',sides:[7,7,7],unit:'ft',anim:'add',sum:21,
    explain:"7 + 7 + 7 = <strong>21 ft</strong>. Three sides ‚Äî add them all!"
  },
  {
    title:"The Equal Sides Puzzle üß©",
    story:"Now flip it around! Jake has exactly <strong>21 ft</strong> of wood. He wants a triangle with ALL EQUAL sides. How long is each side? You don't need to divide ‚Äî just guess and check! Try a number and see if it adds up to 21.",
    shape:'triangle',sides:['?','?','?'],unit:'ft',anim:'guess',answer:7,sidesN:3,target:21,
    explain:"Try 7 ‚Üí 7+7+7 = 21 ‚úÖ  Too small? Go bigger. Too big? Go smaller. Keep trying!"
  },
  {
    title:"Same Perimeter, Different Shape! ü§Ø",
    story:"Here's something cool: two very DIFFERENT shapes can have the exact same perimeter! A square with sides of 5 ft and a triangle with sides of 6+7+7... both have perimeter 20 ft! The distance around is the same even though the shapes look totally different.",
    shape:'square',sides:[5,5,5,5],unit:'ft',anim:'compare',
    shape2:'triangle',sides2:[6,7,7],unit2:'ft',sum:20,sum2:20,
    explain:"Square: 5+5+5+5 = 20 ft. Triangle: 6+7+7 = 20 ft. Same perimeter! Different shapes!"
  },
  {
    title:"Which Perimeter Is Bigger?",
    story:"Can you figure out which shape has the bigger perimeter just by looking? Always add up all the sides to be sure! A small shape can surprise you ‚Äî lots of little sides can add up to more than a few big ones. ü§î",
    shape:'pentagon',sides:[3,3,3,3,3],unit:'m',anim:'add',sum:15,
    explain:"Pentagon: 3+3+3+3+3 = <strong>15 m</strong>. Five sides of 3 each = 15. Always count ALL sides!"
  },
  {
    title:"Pentagons & Hexagons",
    story:"Shapes can have even more sides! A <strong>pentagon</strong> has 5 and a <strong>hexagon</strong> has 6. A honeybee's cell is a hexagon! üêù Same rule ‚Äî just add them all.",
    shape:'hexagon',sides:[4,4,4,4,4,4],unit:'units',anim:'add',sum:24,
    explain:"4+4+4+4+4+4 = <strong>24 units</strong>. Six sides, all equal = 24!"
  },
  {
    title:"Word Problems: Read the Clues!",
    story:"Sometimes perimeter questions are hidden in stories! üìñ 'A farmer needs 30 ft of fence for a rectangular field that is 10 ft long and 5 ft wide.' That's a perimeter question! Draw it: top=10, bottom=10, side=5, side=5. Then add! 10+5+10+5 = 30 ft ‚úÖ",
    shape:'rectangle',sides:[10,5,10,5],unit:'ft',anim:'add',sum:30,
    explain:"10 + 5 + 10 + 5 = <strong>30 ft</strong>. Always find all the sides first, then add!"
  },
  {
    title:"You're a Perimeter Pro! üèÜ",
    story:"You've learned everything! <strong>Perimeter = add ALL the sides, all the way around.</strong> Squares, rectangles, triangles, pentagons, hexagons ‚Äî same rule every time. And if all sides are equal, you can guess-and-check to find each side from the total. Go try the challenges! üéØ",
    shape:'hexagon',sides:[5,5,5,5,5,5],unit:'ft',anim:'add',sum:30,
    explain:"5+5+5+5+5+5 = 30 ft. You've got this! üöÄ"
  }
];

function showLearn(){lStep=0;showScreen('learnScreen');renderLearn();}
window.showLearn=showLearn;

function renderLearn(){
  nlAnimGoing=false;
  const L=LESSONS[lStep];
  document.getElementById('learnDots').innerHTML=LESSONS.map((_,i)=>`<div class="step-dot ${i<lStep?'done':i===lStep?'active':''}"></div>`).join('');

  const sid='lsvg'+lStep, s2id='lsvg2'+lStep;
  let addHTML='',guessHTML='',nlHTML='',compareHTML='';

  if(L.anim==='add'){
    addHTML=`<div class="addition-row" id="addRow">
      ${L.sides.map((s,i)=>`<span class="add-chip" id="lc${i}">${s}</span>${i<L.sides.length-1?'<span class="add-plus">+</span>':''}`).join('')}
      <span class="add-equals">=</span>
      <span class="add-total" id="lTot" style="opacity:0">${L.sum} ${L.unit}</span>
    </div>`;
  }
  if(L.anim==='guess'){
    guessHTML=`<div class="guess-tool">
      <div class="guess-title">üî¢ Try a number ‚Äî does it work?</div>
      <div class="guess-row" id="lgRow"></div>
      <div style="display:flex;align-items:center;gap:7px;margin-top:7px;flex-wrap:wrap;">
        <input class="g-inp" id="lgInp" type="number" min="1" max="30" placeholder="?" inputmode="numeric">
        <button class="g-btn" onclick="learnGuess()">Try it!</button>
      </div>
      <div class="g-fb" id="lgFb"></div>
    </div>`;
  }
  if(L.anim==='numberline'){
    nlHTML=`<div style="margin-top:9px;">
      <div style="font-size:.74rem;font-weight:800;color:var(--mid);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px;">ü¶ò Hop along!</div>
      <div class="nl-wrap"><div class="nl-inner" id="learnNL"></div></div>
      <div id="nlMsg" style="font-family:'Baloo 2',cursive;font-size:.9rem;color:var(--blue);margin-top:5px;min-height:20px;text-align:center;"></div>
      <button class="g-btn" onclick="animNL()" style="margin-top:7px;">‚ñ∂ Watch the hops!</button>
    </div>`;
  }
  if(L.anim==='compare'){
    compareHTML=`<div class="compare-box">
      Try adding both: <strong>${L.sides.join('+')} = ?</strong> and <strong>${L.sides2.join('+')} = ?</strong><br>Are they the same? ü§î
    </div>`;
  }

  const shapeDemoHTML=L.anim==='compare'
    ?`<div class="shape-demo">
        <div><svg id="${sid}" width="130" height="120" viewBox="0 0 130 120"></svg><div class="shape-label">${L.shape}: ${L.sides.join('+')}=${L.sum} ${L.unit}</div></div>
        <div style="font-family:'Baloo 2',cursive;font-size:1.5rem;color:var(--mid);align-self:center;">=</div>
        <div><svg id="${s2id}" width="130" height="120" viewBox="0 0 130 120"></svg><div class="shape-label">${L.shape2}: ${L.sides2.join('+')}=${L.sum2} ${L.unit2}</div></div>
      </div>`
    :`<div class="shape-demo"><svg id="${sid}" width="240" height="190" viewBox="0 0 240 190"></svg></div>`;

  document.getElementById('learnContent').innerHTML=`
    <div class="lesson-card">
      <h2>${L.title}</h2>
      <div class="story-box">${L.story}</div>
      ${shapeDemoHTML}
      ${addHTML}${guessHTML}${nlHTML}${compareHTML}
      <div class="info-box">${L.explain}</div>
    </div>
    <div class="lesson-nav">
      ${lStep>0?`<button class="lesson-btn sec" onclick="learnNav(-1)">‚Üê Back</button>`:''}
      ${lStep<LESSONS.length-1
        ?`<button class="lesson-btn" onclick="learnNav(1)">Next ‚Üí</button>`
        :`<button class="lesson-btn" onclick="showTry()">Try Challenges! üéØ</button>`}
    </div>`;

  // draw
  const svg=document.getElementById(sid);
  const dispSides=L.sides.map(s=>s==='?'?'?':s+' '+L.unit);
  if(svg) drawShape(svg,L.shape,dispSides);
  if(L.anim==='compare'){
    const svg2=document.getElementById(s2id);
    if(svg2) drawShape(svg2,L.shape2,L.sides2.map(s=>s+' '+L.unit2));
  }

  // animate add
  if(L.anim==='add'){
    L.sides.forEach((_,i)=>setTimeout(()=>{
      const c=document.getElementById('lc'+i);if(c)c.classList.add('active');
      if(i===L.sides.length-1)setTimeout(()=>{const t=document.getElementById('lTot');if(t)t.style.opacity='1';},350);
    },380*(i+1)));
  }

  // guess
  if(L.anim==='guess'){
    renderLGRow(L.sidesN,L.target,0);
    const inp=document.getElementById('lgInp');
    if(inp)inp.addEventListener('input',()=>renderLGRow(L.sidesN,L.target,parseInt(inp.value)||0));
  }

  // number line
  if(L.anim==='numberline'){
    const nl=document.getElementById('learnNL');
    if(nl){const mx=L.sum+4;for(let i=0;i<=mx;i++){if(i>0){const d=document.createElement('div');d.className='nl-dash';nl.appendChild(d);}const n=document.createElement('div');n.className='nl-num';n.textContent=i;n.id='lnl'+i;nl.appendChild(n);}}
  }
}

function renderLGRow(n,target,val){
  const row=document.getElementById('lgRow');if(!row)return;
  row.innerHTML='';
  for(let i=0;i<n;i++){const c=document.createElement('span');c.className='g-chip'+(val?' v':'');c.textContent=val||'?';row.appendChild(c);if(i<n-1){const p=document.createElement('span');p.className='add-plus';p.textContent='+';row.appendChild(p);}}
  const eq=document.createElement('span');eq.className='add-equals';eq.textContent='=';row.appendChild(eq);
  const total=val*n;const s=document.createElement('span');s.className='g-chip s'+(total===target?' ok':total>target?' ov':'');s.textContent=val?total:'?';row.appendChild(s);
}

function learnGuess(){
  const L=LESSONS[lStep];const v=parseInt(document.getElementById('lgInp').value)||0;
  const fb=document.getElementById('lgFb');const total=v*L.sidesN;
  if(v===L.answer){fb.style.color='var(--green)';fb.textContent=`üéâ YES! ${v}+${v}+${v}=${total}. Each side = ${v} ft!`;const svg=document.getElementById('lsvg'+lStep);if(svg)drawShape(svg,'triangle',[v+' ft',v+' ft',v+' ft']);}
  else if(total<L.target){fb.style.color='var(--blue)';fb.textContent=`${v}+${v}+${v}=${total} ‚Äî too small! Try bigger.`;}
  else{fb.style.color='var(--red)';fb.textContent=`${v}+${v}+${v}=${total} ‚Äî too big! Try smaller.`;}
}
window.learnGuess=learnGuess;

function animNL(){
  if(nlAnimGoing)return;nlAnimGoing=true;
  const L=LESSONS[lStep];
  for(let i=0;i<=L.sum+4;i++){const el=document.getElementById('lnl'+i);if(el)el.className='nl-num';}
  let pos=0,si=0;
  const msgs=['Start at 0!',...L.hops.map((h,i)=>`Hop +${h} ‚Üí land on ${L.hops.slice(0,i+1).reduce((a,b)=>a+b,0)}`),'Perimeter = '+L.sum+' '+L.unit+' üéâ'];
  const step=()=>{
    if(si>L.hops.length){nlAnimGoing=false;return;}
    const msg=document.getElementById('nlMsg');if(msg)msg.textContent=msgs[si]||'';
    const el=document.getElementById('lnl'+pos);if(el){el.className='nl-num hop';setTimeout(()=>{if(el)el.className='nl-num marked';},300);}
    if(si<L.hops.length){pos+=L.hops[si];si++;setTimeout(step,680);}else{si++;setTimeout(step,680);}
  };
  step();
}
window.animNL=animNL;

function learnNav(dir){lStep=Math.max(0,Math.min(LESSONS.length-1,lStep+dir));renderLearn();}
window.learnNav=learnNav;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHALLENGE GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rnd(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
const UNITS=['ft','m','units','cm'];
function rUnit(){return UNITS[rnd(0,3)];}

// validated shape makers
function mkSquare(){const s=rnd(2,10);return{shape:'square',sides:[s,s,s,s],n:4,equal:true,sv:s};}
function mkRect(){let w=rnd(3,12),h=rnd(2,7);if(w===h)h=Math.max(1,h-1);return{shape:'rectangle',sides:[w,h,w,h],n:4,equal:false};}
function mkTri(eq=true){if(eq){const s=rnd(2,10);return{shape:'triangle',sides:[s,s,s],n:3,equal:true,sv:s};}return{shape:'triangle',sides:[rnd(2,8),rnd(2,8),rnd(2,8)],n:3,equal:false};}
function mkPent(eq=true){if(eq){const s=rnd(2,7);return{shape:'pentagon',sides:[s,s,s,s,s],n:5,equal:true,sv:s};}return{shape:'pentagon',sides:Array.from({length:5},()=>rnd(2,6)),n:5,equal:false};}
function mkHex(eq=true){if(eq){const s=rnd(2,5);return{shape:'hexagon',sides:[s,s,s,s,s,s],n:6,equal:true,sv:s};}return{shape:'hexagon',sides:Array.from({length:6},()=>rnd(2,5)),n:6,equal:false};}

const WORD_CTX=[
  sh=>`üåª A garden is shaped like a ${sh}. How much fence is needed to go all the way around?`,
  sh=>`üêï A dog park needs a fence around a ${sh}-shaped yard. What is the perimeter?`,
  sh=>`üñºÔ∏è Emma is gluing ribbon around a ${sh}-shaped picture frame. How much ribbon does she need?`,
  sh=>`üèä A ${sh}-shaped swimming pool needs a rope around the edge. How long is the rope?`,
  sh=>`üéÇ A ${sh}-shaped cake needs frosting piped around every edge. How far does the frosting go?`,
  sh=>`üè´ The classroom has a ${sh}-shaped rug. How long is the border around it?`,
  sh=>`‚õ∫ A campsite is marked off in a ${sh} shape. How far is it to walk the whole boundary?`,
  sh=>`üåä A sandcastle wall is built in a ${sh} shape. How long is the total wall?`,
];

// MATCH PERIMETER: Shape A is given, find side of shape B with same perimeter
function mkMatchChallenge(){
  // Shape A options ‚Äî ones we can easily control
  const aOptions=[
    ()=>{const d=mkRect();const p=d.sides.reduce((a,b)=>a+b,0);return{...d,p};},
    ()=>{const d=mkSquare();const p=d.sides.reduce((a,b)=>a+b,0);return{...d,p};},
    ()=>{const d=mkTri(false);const p=d.sides.reduce((a,b)=>a+b,0);return{...d,p};},
  ];
  const shA=aOptions[rnd(0,aOptions.length-1)]();

  // Shape B must be equal-sided and have a clean answer
  const bOptions=[
    {shape:'triangle',n:3},{shape:'square',n:4},{shape:'pentagon',n:5},{shape:'hexagon',n:6}
  ].filter(b=>b.shape!==shA.shape);
  const shBDef=bOptions[rnd(0,bOptions.length-1)];

  // find a perimeter divisible by shB.n
  // adjust shA perimeter if needed
  let p=shA.p;
  let attempts=0;
  while(p%shBDef.n!==0&&attempts<20){
    // tweak one side of shA
    if(shA.shape==='rectangle'){
      const idx=rnd(0,1)===0?0:1;
      shA.sides[idx]+=1;
      shA.sides[shA.sides.length-1-idx]=shA.sides[idx===0?2:3]=shA.sides[idx===0?0:1];
      // fix opposite
      if(shA.shape==='rectangle'){shA.sides[2]=shA.sides[0];shA.sides[3]=shA.sides[1];}
    } else {
      shA.sides[0]+=1;
      if(shA.equal) for(let i=1;i<shA.n;i++)shA.sides[i]=shA.sides[0];
    }
    p=shA.sides.reduce((a,b)=>a+b,0);
    attempts++;
  }
  if(p%shBDef.n!==0) return null; // fallback

  const answer=p/shBDef.n;
  const u=rUnit();
  const shBSides=new Array(shBDef.n).fill(answer);

  return{
    type:'match_perimeter',
    shA:{...shA},shB:{shape:shBDef.shape,sides:shBSides,n:shBDef.n,equal:true,sv:answer},
    unit:u,answer,perimeter:p,
    question:`This ${shA.shape} has all its sides labeled.\n\nA ${shBDef.shape} has the <strong>SAME perimeter</strong> and all equal sides.\n\nWhat is the length of each side of the ${shBDef.shape}?`,
    hint:`First find the perimeter of the ${shA.shape}: ${shA.sides.join('+')}=${p}. Then: what number √ó ${shBDef.n} = ${p}?`
  };
}

// difficulty 0-2: find perimeter (simple shapes)
// difficulty 3-5: word problems (mixed shapes)
// difficulty 6-8: match perimeter
// difficulty 9+: equal sides puzzle + hard mix
const CTYPE_WEIGHTS=[
  // [find, word, match, equal]
  [0.7,0.3,0.0,0.0], // diff 0
  [0.6,0.4,0.0,0.0], // diff 1
  [0.5,0.4,0.1,0.0], // diff 2
  [0.4,0.35,0.2,0.05],// diff 3
  [0.3,0.35,0.25,0.1], // diff 4
  [0.25,0.3,0.3,0.15], // diff 5
  [0.2,0.25,0.3,0.25], // diff 6
  [0.15,0.25,0.3,0.3], // diff 7+
];

function pickType(diff){
  const w=CTYPE_WEIGHTS[Math.min(diff,CTYPE_WEIGHTS.length-1)];
  const r=Math.random();
  let cum=0;
  const types=['find','word','match','equal'];
  for(let i=0;i<w.length;i++){cum+=w[i];if(r<cum)return types[i];}
  return 'find';
}

function mkChallenge(diff){
  const type=pickType(diff);
  const u=rUnit();

  if(type==='match'){
    const ch=mkMatchChallenge();
    if(ch) return ch;
    // fallback to word
  }

  if(type==='find'){
    const makers=[mkSquare,mkRect,()=>mkTri(true),()=>mkTri(false),mkPent,mkHex];
    // simpler shapes for low diff
    const pool=diff<2?[mkSquare,mkRect]:makers;
    const sd=pool[rnd(0,pool.length-1)]();
    const ans=sd.sides.reduce((a,b)=>a+b,0);
    return{type:'find_perimeter',sd,unit:u,answer:ans,
      question:`What is the perimeter of this ${sd.shape}?`,
      hint:`Add all ${sd.n} sides: ${sd.sides.join(' + ')} = ?`};
  }

  if(type==='word'){
    const makers=[mkSquare,mkRect,()=>mkTri(true),()=>mkTri(false),diff>=3?mkPent:mkRect,diff>=4?mkHex:mkSquare];
    const sd=makers[rnd(0,makers.length-1)]();
    const ans=sd.sides.reduce((a,b)=>a+b,0);
    const ctx=WORD_CTX[rnd(0,WORD_CTX.length-1)](sd.shape);
    return{type:'word_perimeter',sd,unit:u,answer:ans,
      question:ctx+`\n\nEach side is labeled in the picture.`,
      hint:`Add: ${sd.sides.join(' + ')} = ?`};
  }

  // equal sides
  const eqMakers=[()=>mkTri(true),mkSquare,()=>mkPent(true),()=>mkHex(true)];
  const sd=eqMakers[rnd(0,eqMakers.length-1)]();
  const perim=sd.sides.reduce((a,b)=>a+b,0);
  return{type:'equal_sides',sd,unit:u,answer:sd.sv,perimeter:perim,
    question:`A ${sd.shape} has a perimeter of ${perim} ${u}.\nAll ${sd.n} sides are equal.\n\nWhat is the length of each side?`,
    hint:`There are ${sd.n} equal sides. Try: what number √ó ${sd.n} = ${perim}?`};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRY MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let diff=0,curCh=null,answered=false;

function showTry(){showScreen('tryScreen');updateHUD();loadCh();}
window.showTry=showTry;

function loadCh(){
  answered=false;
  let ch=mkChallenge(diff);
  // safety: retry once if null
  if(!ch)ch=mkChallenge(Math.max(0,diff-1));
  curCh=ch;

  const sd=ch.type==='match_perimeter'?ch.shA:ch.sd;
  const isMatch=ch.type==='match_perimeter';
  const isEqual=ch.type==='equal_sides';

  // Build question labels
  const qLabels=isMatch?sd.sides.map(s=>s+' '+ch.unit):
    isEqual?sd.sides.map(()=>'?'):
    sd.sides.map(s=>s+' '+ch.unit);

  // Number line for find/word types
  let toolsHTML='';
  if(!isEqual&&!isMatch){
    const mx=Math.max(ch.answer+6,30);
    toolsHTML=`<div style="margin-top:10px;">
      <div style="font-size:.72rem;font-weight:800;color:var(--mid);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px;">üî¢ Number line ‚Äî tap to mark your counting!</div>
      <div class="nl-wrap"><div class="nl-inner" id="tryNL"></div></div>
    </div>`;
  }

  // Equal sides tool
  let estHTML='';
  if(isEqual||isMatch){
    const n=isMatch?ch.shB.n:sd.n;
    const perim=isMatch?ch.perimeter:ch.perimeter;
    estHTML=`<div class="est-wrap">
      <div class="est-title">üî¢ Guess and check ‚Äî try a number!</div>
      <div class="est-chips" id="estChips"></div>
      <div class="est-row">
        <input class="est-inp" id="estInp" type="number" min="1" max="60" placeholder="?" inputmode="numeric">
        <button class="est-btn" onclick="doEstimate()">Try it!</button>
      </div>
      <div class="est-fb" id="estFb"></div>
    </div>`;
  }

  const badgeCls=isMatch?'badge-match':ch.type==='find_perimeter'?'badge-find':ch.type==='word_perimeter'?'badge-word':'badge-equal';
  const badgeTxt=isMatch?'üî∑ Match the Perimeter':ch.type==='find_perimeter'?'üîç Find the Perimeter':ch.type==='word_perimeter'?'üìñ Word Problem':'üî∑ Equal Sides Puzzle';
  const ansLbl=isEqual?'Each side length:':isMatch?`Each side of the ${ch.shB.shape}:`:'Perimeter =';

  // Shape display area
  let shapeHTML='';
  if(isMatch){
    shapeHTML=`<div class="shape-display">
      <div><svg id="tryShapeA" width="130" height="120" viewBox="0 0 130 120"></svg><div class="shape-label">${ch.shA.shape.charAt(0).toUpperCase()+ch.shA.shape.slice(1)} (given)</div></div>
      <div style="font-family:'Baloo 2',cursive;font-size:1.3rem;color:var(--mid);align-self:center;">‚Üí same perimeter ‚Üí</div>
      <div><svg id="tryShapeB" width="130" height="120" viewBox="0 0 130 120"></svg><div class="shape-label">${ch.shB.shape.charAt(0).toUpperCase()+ch.shB.shape.slice(1)} (find each side)</div></div>
    </div>`;
  } else {
    shapeHTML=`<div class="shape-display"><svg id="trySvg" width="230" height="185" viewBox="0 0 230 185"></svg></div>`;
  }

  document.getElementById('challengeContent').innerHTML=`
    <div class="ch-card">
      <div class="ch-badge ${badgeCls}">${badgeTxt}</div>
      <div class="ch-q">${ch.question.replace(/\n/g,'<br>')}</div>
      ${shapeHTML}
      ${toolsHTML}${estHTML}
      <div class="ans-section">
        <div class="ans-lbl">${ansLbl}</div>
        <div class="ans-row">
          <input class="ans-inp" id="tryAns" type="number" min="0" max="500" placeholder="?" inputmode="numeric">
          <span class="ans-unit">${ch.unit}</span>
        </div>
        <button class="check-btn" id="checkBtn" onclick="doCheck()">Check it! ‚úì</button>
        <div class="try-fb" id="tryFb"></div>
        <button class="next-btn hidden" id="nextBtn" onclick="loadCh()">Next Challenge ‚Üí</button>
      </div>
    </div>`;

  // draw shapes
  if(isMatch){
    const svgA=document.getElementById('tryShapeA');
    if(svgA)drawShape(svgA,ch.shA.shape,ch.shA.sides.map(s=>s+' '+ch.unit));
    const svgB=document.getElementById('tryShapeB');
    if(svgB)drawShape(svgB,ch.shB.shape,ch.shB.sides.map(()=>'?'));
  } else {
    const svg=document.getElementById('trySvg');
    if(svg)drawShape(svg,sd.shape,qLabels);
  }

  // number line
  if(toolsHTML){
    const mx=Math.max(ch.answer+6,32);
    const nl=document.getElementById('tryNL');
    if(nl){for(let i=0;i<=mx;i++){if(i>0){const d=document.createElement('div');d.className='nl-dash';nl.appendChild(d);}const n=document.createElement('div');n.className='nl-num';n.textContent=i;n.onclick=function(){this.classList.toggle('marked');};nl.appendChild(n);}}
  }

  // estimate chips
  if(estHTML){
    const n=isMatch?ch.shB.n:(curCh.sd?curCh.sd.n:3);
    const perim=ch.perimeter;
    renderEst(n,perim,0);
    const inp=document.getElementById('estInp');
    if(inp)inp.addEventListener('input',()=>renderEst(n,perim,parseInt(inp.value)||0));
  }

  const ans=document.getElementById('tryAns');
  if(ans)ans.addEventListener('keydown',e=>{if(e.key==='Enter')doCheck();});
}

function renderEst(n,perim,val){
  const row=document.getElementById('estChips');if(!row)return;
  row.innerHTML='';
  for(let i=0;i<n;i++){const c=document.createElement('span');c.className='est-chip'+(val?' v':'');c.textContent=val||'?';row.appendChild(c);if(i<n-1){const p=document.createElement('span');p.style.cssText='font-size:.85rem;color:var(--mid);font-weight:800;';p.textContent='+';row.appendChild(p);}}
  const eq=document.createElement('span');eq.style.cssText='font-size:.85rem;color:var(--mid);font-weight:800;';eq.textContent='=';row.appendChild(eq);
  const total=val*n;const s=document.createElement('span');
  s.className='est-chip s'+(total===perim?' ok':total>perim?' ov':'');
  s.textContent=val?total:'?';row.appendChild(s);
}

function doEstimate(){
  const ch=curCh;
  const isMatch=ch.type==='match_perimeter';
  const n=isMatch?ch.shB.n:ch.sd.n;
  const perim=ch.perimeter;
  const v=parseInt(document.getElementById('estInp').value)||0;
  const fb=document.getElementById('estFb');
  const total=v*n;
  if(v===ch.answer){fb.style.color='var(--green)';fb.textContent=`‚úÖ Yes! ${v} √ó ${n} = ${total}! Type ${v} as your answer!`;document.getElementById('tryAns').value=v;}
  else if(total<perim){fb.style.color='var(--blue)';fb.textContent=`${v}√ó${n}=${total} ‚Äî too small! Try bigger!`;}
  else{fb.style.color='var(--red)';fb.textContent=`${v}√ó${n}=${total} ‚Äî too big! Try smaller!`;}
}
window.doEstimate=doEstimate;

function doCheck(){
  if(answered)return;
  const ch=curCh;
  const val=parseInt(document.getElementById('tryAns').value);
  const fb=document.getElementById('tryFb');
  const input=document.getElementById('tryAns');
  if(isNaN(val)){fb.textContent='‚ö†Ô∏è Type a number first!';fb.className='try-fb hint';return;}

  if(val===ch.answer){
    answered=true;
    input.classList.add('ok');
    fb.textContent='üéâ Correct!';fb.className='try-fb ok';
    document.getElementById('checkBtn').disabled=true;
    const earned=earnXP(true);
    const leveled=addXP(earned);
    if(leveled){const f=document.createElement('div');f.className='lvl-flash';document.body.appendChild(f);setTimeout(()=>f.remove(),700);}
    showCeleb(earned,leveled);
    diff++;
  } else {
    earnXP(false);
    input.classList.add('no');
    fb.textContent=`Not quite ‚Äî ${val<ch.answer?'too small üìâ':'too big üìà'}! Hint: ${ch.hint}`;
    fb.className='try-fb no';
    setTimeout(()=>{input.classList.remove('no');input.value='';},1400);
  }
}
window.doCheck=doCheck;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CELEBRATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CELEBS=[
  {e:'üéâ',t:'Amazing!',m:'You nailed it!'},
  {e:'‚≠ê',t:'Superstar!',m:'You are SO good at this!'},
  {e:'üèÜ',t:'Champion!',m:'Nothing can stop you!'},
  {e:'üöÄ',t:'Blast Off!',m:'To the moon! üåô'},
  {e:'üéä',t:'Fantastic!',m:'Brilliant work!'},
  {e:'üí•',t:'Boom!',m:'That was explosive!'},
  {e:'ü¶∏',t:'Math Hero!',m:'You\'re a math superhero!'},
  {e:'üåü',t:'Dazzling!',m:'You shine so bright!'},
  {e:'üî•',t:'On Fire!',m:'You\'re unstoppable!'},
  {e:'üß†',t:'Big Brain!',m:'Your brain is huge!'},
];
function showCeleb(earned,leveled){
  const c=CELEBS[Math.floor(Math.random()*CELEBS.length)];
  document.getElementById('cEmoji').textContent=c.e;
  document.getElementById('cTitle').textContent=leveled?'LEVEL UP! üÜô':c.t;
  document.getElementById('cXp').textContent=`+${earned} XP${streak>=3?' üî• √ó'+streak+' streak!':''}`;
  const sd=getSD();
  document.getElementById('cStreak').textContent=streak>=3?`${sd.icon.repeat(Math.min(streak,6))} ${sd.lbl} ‚Äî ${streak} in a row!`:streak===2?'‚ú® 2 in a row!':'';
  document.getElementById('cMsg').textContent=leveled?`You reached ${getLv().title}!`:c.m;
  document.getElementById('celebration').classList.remove('hidden');
  confetti(streak>=5?60:30);
}
function celebNext(){document.getElementById('celebration').classList.add('hidden');loadCh();}
window.celebNext=celebNext;
function confetti(n){
  const cols=['#FFD93D','#FF6B35','#6BCB77','#4D96FF','#C77DFF','#FF4D6D','#2EC4B6','#FF8C42'];
  for(let i=0;i<n;i++){const p=document.createElement('div');p.className='confetti-piece';p.style.cssText=`left:${Math.random()*100}vw;background:${cols[rnd(0,cols.length-1)]};width:${5+Math.random()*8}px;height:${5+Math.random()*8}px;border-radius:${Math.random()>.5?'50%':'2px'};animation-duration:${1.5+Math.random()*2.5}s;animation-delay:${Math.random()*.5}s;`;document.body.appendChild(p);setTimeout(()=>p.remove(),3800);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPLORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EXP_SH=[
  {id:'square',    lbl:'Square',   icon:'üü¶',sides:4,groups:[[0,1,2,3]],       glbls:['All sides']},
  {id:'rectangle', lbl:'Rectangle',icon:'‚ñ¨', sides:4,groups:[[0,2],[1,3]],     glbls:['Top / Bottom','Left / Right']},
  {id:'triangle',  lbl:'Triangle', icon:'üî∫',sides:3,groups:[[0,1,2]],         glbls:['All sides']},
  {id:'pentagon',  lbl:'Pentagon', icon:'‚¨†', sides:5,groups:[[0,1,2,3,4]],     glbls:['All sides']},
  {id:'hexagon',   lbl:'Hexagon',  icon:'‚¨°', sides:6,groups:[[0,1,2,3,4,5]],   glbls:['All sides']},
];
const EXP_UNITS=['ft','m','cm','units'];
let expSh=EXP_SH[0],expVals=[5,5,5,5,5,5],expUnit='ft';

function showExplore(){showScreen('exploreScreen');buildExpSel();selectExpSh(EXP_SH[0]);}
window.showExplore=showExplore;

function buildExpSel(){
  document.getElementById('shapeSel').innerHTML=EXP_SH.map(s=>`
    <div class="ss-btn ${s.id===expSh.id?'active':''}" id="esb_${s.id}" onclick="selectExpSh(window._esh['${s.id}'])">
      <span class="ss-icon">${s.icon}</span><span>${s.lbl}</span>
    </div>`).join('');
  window._esh={};EXP_SH.forEach(s=>window._esh[s.id]=s);
}

function selectExpSh(sh){
  expSh=sh;
  // default values
  if(sh.id==='rectangle'){expVals=[8,4,8,4,5,5];}
  else{expVals=[5,5,5,5,5,5];}
  document.querySelectorAll('.ss-btn').forEach(b=>b.classList.remove('active'));
  const btn=document.getElementById('esb_'+sh.id);if(btn)btn.classList.add('active');
  renderExpSliders();
  updateExplore();
}
window.selectExpSh=selectExpSh;

function renderExpSliders(){
  const sh=expSh;
  document.getElementById('slidersWrap').innerHTML=sh.groups.map((grp,gi)=>{
    const val=expVals[grp[0]];
    const lbl=sh.glbls[gi]||('Side '+(gi+1));
    return`<div class="sl-card">
      <div class="sl-lbl">${lbl}<span class="sl-val" id="esv${gi}">${val} ${expUnit}</span></div>
      <input type="range" min="1" max="20" value="${val}" oninput="onExpSlide(${gi},[${grp.join(',')}],this.value)">
    </div>`;
  }).join('');
  document.getElementById('unitRow').innerHTML=EXP_UNITS.map(u=>`<button class="unit-btn ${u===expUnit?'active':''}" onclick="setExpUnit('${u}')">${u}</button>`).join('');
}

function onExpSlide(gi,grp,val){
  val=parseInt(val);
  grp.forEach(i=>expVals[i]=val);
  const lbl=document.getElementById('esv'+gi);if(lbl)lbl.textContent=val+' '+expUnit;
  updateExplore();
}
window.onExpSlide=onExpSlide;

function setExpUnit(u){expUnit=u;renderExpSliders();updateExplore();}
window.setExpUnit=setExpUnit;

// Draw explore shape using actual slider values for geometry
function drawShapeExplore(svgEl,shape,vals,labels){
  svgEl.innerHTML='';
  const W=+svgEl.getAttribute('width'),H=+svgEl.getAttribute('height');
  // For explore, vals drives the visual shape geometry
  // For rectangle: vals[0]=top/bottom length, vals[1]=left/right length
  // For all-equal shapes: vals[0]=side length
  const exploreVals=(shape==='rectangle')?[vals[0],vals[1]]:[vals[0]];
  const pts=getPointsForExplore(shape,W,H,exploreVals);
  const c=SC[shape]||SC.square;

  const poly=document.createElementNS('http://www.w3.org/2000/svg','polygon');
  poly.setAttribute('points',pts.map(p=>p.join(',')).join(' '));
  poly.setAttribute('fill',c.fill);
  poly.setAttribute('stroke',c.stroke);
  poly.setAttribute('stroke-width','3');
  svgEl.appendChild(poly);

  if(!labels||!labels.length) return;
  const cx=W/2,cy=H/2;
  labels.forEach((lbl,i)=>{
    if(lbl===null||lbl===undefined) return;
    const a=pts[i],b=pts[(i+1)%pts.length];
    const mx=(a[0]+b[0])/2,my=(a[1]+b[1])/2;
    const dx=mx-cx,dy=my-cy,dist=Math.sqrt(dx*dx+dy*dy)||1;
    const ox=mx+dx/dist*26,oy=my+dy/dist*24;
    const tw=Math.max(34,String(lbl).length*8+14);
    const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
    const txt=document.createElementNS('http://www.w3.org/2000/svg','text');
    rect.setAttribute('x',ox-tw/2);rect.setAttribute('y',oy-12);rect.setAttribute('width',tw);rect.setAttribute('height','24');rect.setAttribute('rx','6');
    rect.setAttribute('fill','#FFD93D');rect.setAttribute('stroke',c.stroke);rect.setAttribute('stroke-width','1.5');
    txt.setAttribute('x',ox);txt.setAttribute('y',oy+4);txt.setAttribute('text-anchor','middle');
    txt.setAttribute('font-family','Baloo 2, cursive');txt.setAttribute('font-size','11');txt.setAttribute('font-weight','700');
    txt.setAttribute('fill','#3D2B1F');txt.textContent=String(lbl);
    g.appendChild(rect);g.appendChild(txt);svgEl.appendChild(g);
  });
}

function updateExplore(){
  const sh=expSh;
  const used=expVals.slice(0,sh.sides);
  const perim=used.reduce((a,b)=>a+b,0);

  document.getElementById('perimVal').textContent=perim;
  document.getElementById('perimUnit').textContent=' '+expUnit;
  document.getElementById('addDisplay').textContent=used.join(' + ')+' = '+perim;

  const svg=document.getElementById('expSvg');
  // Pass unique side values for geometry scaling
  // Rectangle: group vals are [top/bottom, left/right]
  const geoVals=sh.groups.map(grp=>expVals[grp[0]]);
  drawShapeExplore(svg,sh.id,geoVals,used.map(v=>v+' '+expUnit));

  const isEqual=new Set(used).size===1;
  document.getElementById('expFacts').innerHTML=`
    <div class="fact-chip">Sides: <strong>${sh.sides}</strong></div>
    <div class="fact-chip">Perimeter: <strong>${perim} ${expUnit}</strong></div>
    ${isEqual?`<div class="fact-chip">${used[0]} √ó ${sh.sides} = <strong>${perim}</strong></div>`:''}
    ${!isEqual?`<div class="fact-chip">Longest: <strong>${Math.max(...used)} ${expUnit}</strong></div>`:''}
    ${!isEqual?`<div class="fact-chip">Shortest: <strong>${Math.min(...used)} ${expUnit}</strong></div>`:''}
  `;
}

// boot
updateHomeXP();
</script>
</body>
</html>
