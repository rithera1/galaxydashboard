<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸŒ Geo Guesser â€” Galaxy Dashboard</title>
<link rel="icon" href="../favicon.svg" type="image/svg+xml">
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root {
  --beige: #f5ead6;
  --beige-dark: #ecdcc0;
  --beige-darker: #e0c99a;
  --cream: #fdf6e8;
  --ink: #3b2f1e;
  --ink-light: #7a5c3a;
  --red: #e8453c;
  --orange: #f5832a;
  --yellow: #f7c948;
  --teal: #3dbfb0;
  --blue: #4a90d9;
  --purple: #9b6fda;
  --green: #5cbb6f;
  --pink: #e8668a;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--beige);
  font-family: 'Nunito', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
  color: var(--ink);
}

/* â”€â”€ TOP BAR â”€â”€ */
.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.7rem 1.2rem;
  background: var(--cream);
  border-bottom: 3px solid var(--ink);
  position: sticky;
  top: 0;
  z-index: 1100;
  gap: 0.5rem;
}

.topbar-left {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  flex-shrink: 0;
}

.back-btn {
  font-family: 'Fredoka One', cursive;
  font-size: 0.95rem;
  color: var(--ink);
  text-decoration: none;
  background: var(--beige);
  border: 2.5px solid var(--ink);
  border-radius: 12px;
  padding: 0.3rem 0.75rem;
  transition: background 0.15s;
  white-space: nowrap;
}
.back-btn:hover { background: var(--beige-darker); }

.game-title {
  font-family: 'Fredoka One', cursive;
  font-size: clamp(1.1rem, 3vw, 1.6rem);
  color: var(--ink);
}

.topbar-stats {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  flex-wrap: wrap;
  justify-content: flex-end;
}

.stat-chip {
  font-family: 'Fredoka One', cursive;
  font-size: 0.9rem;
  padding: 0.25rem 0.65rem;
  border-radius: 20px;
  border: 2px solid var(--ink);
  white-space: nowrap;
}
.stat-chip.score-chip { background: #fef3c2; }
.stat-chip.round-chip { background: #dbeeff; }
.stat-chip.streak-chip { background: #fde0ea; }

/* â”€â”€ SCREENS â”€â”€ */
.screen {
  display: none;
  min-height: calc(100vh - 58px);
}
.screen.active { display: flex; flex-direction: column; }

/* â”€â”€ START SCREEN â”€â”€ */
#startScreen {
  align-items: center;
  justify-content: center;
  padding: 2rem 1.5rem;
  text-align: center;
}

.start-globe {
  font-size: 5rem;
  animation: globeSpin 4s ease-in-out infinite;
  filter: drop-shadow(0 8px 16px rgba(0,0,0,0.12));
  margin-bottom: 0.5rem;
}
@keyframes globeSpin {
  0%, 100% { transform: rotate(-8deg) scale(1); }
  50%       { transform: rotate(8deg) scale(1.05); }
}

.start-title {
  font-family: 'Fredoka One', cursive;
  font-size: clamp(2rem, 7vw, 3.2rem);
  color: var(--ink);
  line-height: 1.1;
  margin-bottom: 0.4rem;
}
.start-title span { color: var(--blue); }

.start-sub {
  color: var(--ink-light);
  font-weight: 700;
  font-size: 1rem;
  margin-bottom: 2rem;
}

.mode-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  max-width: 680px;
  width: 100%;
  margin-bottom: 2rem;
}

.mode-card {
  background: var(--cream);
  border: 3px solid var(--ink);
  border-radius: 20px;
  padding: 1.4rem 0.8rem;
  cursor: pointer;
  transition: transform 0.18s cubic-bezier(.34,1.56,.64,1), box-shadow 0.18s;
  box-shadow: 4px 4px 0 var(--ink);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  position: relative;
  overflow: hidden;
}
.mode-card::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 17px;
  opacity: 0;
  transition: opacity 0.2s;
}
.mode-card:hover {
  transform: translateY(-5px) scale(1.03);
  box-shadow: 4px 4px 0 var(--ink), 0 0 24px 6px var(--glow);
}
.mode-card:hover::after { opacity: 1; }
.mode-card:active { transform: scale(0.97); }
.mode-card.selected {
  transform: translateY(-4px) scale(1.03);
  box-shadow: 4px 4px 0 var(--ink), 0 0 24px 8px var(--glow);
}
.mode-card.selected::before {
  content: 'âœ“';
  position: absolute;
  top: 8px; right: 10px;
  font-family: 'Fredoka One', cursive;
  font-size: 1.1rem;
  color: var(--ink);
}

.mode-card.m-states  { --glow: rgba(61,191,176,0.5); }
.mode-card.m-cities  { --glow: rgba(74,144,217,0.5); }
.mode-card.m-world   { --glow: rgba(155,111,218,0.5); }

.mode-card.m-states  { background: #d6f5f2; }
.mode-card.m-cities  { background: #dbeeff; }
.mode-card.m-world   { background: #ede0ff; }

.mode-emoji { font-size: 2.6rem; }
.mode-label {
  font-family: 'Fredoka One', cursive;
  font-size: 1.05rem;
  color: var(--ink);
}
.mode-desc {
  font-size: 0.75rem;
  color: var(--ink-light);
  font-weight: 700;
  text-align: center;
  line-height: 1.3;
}

.diff-row {
  display: flex;
  gap: 0.6rem;
  margin-bottom: 1.5rem;
  align-items: center;
}
.diff-label {
  font-family: 'Fredoka One', cursive;
  font-size: 0.95rem;
  color: var(--ink-light);
}
.diff-btn {
  font-family: 'Fredoka One', cursive;
  font-size: 0.9rem;
  padding: 0.3rem 0.85rem;
  border-radius: 20px;
  border: 2.5px solid var(--ink);
  background: var(--cream);
  cursor: pointer;
  transition: background 0.15s, transform 0.1s;
}
.diff-btn:hover { background: var(--beige-darker); }
.diff-btn.active { background: var(--yellow); font-weight: 800; transform: scale(1.05); }

.start-btn {
  font-family: 'Fredoka One', cursive;
  font-size: 1.35rem;
  padding: 0.85rem 3rem;
  background: var(--green);
  color: white;
  border: 3px solid var(--ink);
  border-radius: 50px;
  cursor: pointer;
  box-shadow: 4px 4px 0 var(--ink);
  transition: transform 0.18s cubic-bezier(.34,1.56,.64,1), box-shadow 0.15s;
}
.start-btn:hover {
  transform: translateY(-3px) scale(1.04);
  box-shadow: 4px 4px 0 var(--ink), 0 0 20px 6px rgba(92,187,111,0.5);
}
.start-btn:active { transform: scale(0.97); box-shadow: 2px 2px 0 var(--ink); }
.start-btn:disabled {
  background: var(--beige-darker);
  color: var(--ink-light);
  cursor: not-allowed;
  box-shadow: 2px 2px 0 var(--ink);
  transform: none;
}

/* â”€â”€ GAME SCREEN â”€â”€ */
#gameScreen {
  flex: 1;
  display: none;
  flex-direction: column;
}
#gameScreen.active { display: flex; }

.question-bar {
  background: var(--cream);
  border-bottom: 3px solid var(--beige-darker);
  padding: 0.7rem 1.2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.8rem;
  flex-wrap: wrap;
}

.question-text {
  font-family: 'Fredoka One', cursive;
  font-size: clamp(1.05rem, 3.5vw, 1.5rem);
  color: var(--ink);
  flex: 1;
}
.question-text span {
  color: var(--blue);
}

.timer-bar-wrap {
  width: 120px;
  height: 12px;
  background: var(--beige-dark);
  border-radius: 10px;
  border: 2px solid var(--ink);
  overflow: hidden;
  flex-shrink: 0;
}
.timer-bar-fill {
  height: 100%;
  background: var(--green);
  border-radius: 8px;
  transition: width 1s linear, background 0.5s;
  width: 100%;
}
.timer-bar-fill.warn { background: var(--orange); }
.timer-bar-fill.danger { background: var(--red); }

/* Map wrapper */
.map-wrap {
  flex: 1;
  position: relative;
  overflow: hidden;
  min-height: 320px;
}

/* Leaflet container fills the map-wrap */
#mapContainer {
  position: absolute;
  inset: 0;
  z-index: 1;
}

/* Override Leaflet cursor for game feel */
.leaflet-container {
  cursor: crosshair !important;
  font-family: 'Nunito', sans-serif;
}
.leaflet-grab { cursor: crosshair !important; }
.leaflet-dragging .leaflet-container { cursor: grabbing !important; }

/* Result overlay â€” must sit above Leaflet's layers (markers are z ~600) */
.result-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(253,246,232,0.97);
  border-top: 3px solid var(--ink);
  padding: 1rem 1.4rem;
  display: none;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  z-index: 1000;
  flex-wrap: wrap;
}
.result-overlay.show { display: flex; }

.result-info { flex: 1; min-width: 0; }
.result-name {
  font-family: 'Fredoka One', cursive;
  font-size: 1.3rem;
  color: var(--ink);
  margin-bottom: 0.2rem;
}
.result-detail {
  font-size: 0.85rem;
  color: var(--ink-light);
  font-weight: 700;
}

.result-score-badge {
  font-family: 'Fredoka One', cursive;
  font-size: 1.9rem;
  padding: 0.4rem 1.1rem;
  border-radius: 20px;
  border: 3px solid var(--ink);
  background: var(--yellow);
  white-space: nowrap;
  animation: popIn 0.35s cubic-bezier(.34,1.56,.64,1) both;
}
@keyframes popIn {
  from { transform: scale(0.4); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}
.result-score-badge.perfect { background: #a8f0b0; }
.result-score-badge.great   { background: var(--yellow); }
.result-score-badge.ok      { background: #ffd4a0; }
.result-score-badge.poor    { background: #ffc0c0; }

.next-btn {
  font-family: 'Fredoka One', cursive;
  font-size: 1.1rem;
  padding: 0.6rem 1.6rem;
  background: var(--blue);
  color: white;
  border: 3px solid var(--ink);
  border-radius: 40px;
  cursor: pointer;
  box-shadow: 3px 3px 0 var(--ink);
  transition: transform 0.15s, box-shadow 0.15s;
  white-space: nowrap;
}
.next-btn:hover { transform: translateY(-2px); box-shadow: 3px 3px 0 var(--ink), 0 0 14px rgba(74,144,217,0.5); }
.next-btn:active { transform: scale(0.97); }

/* Hint bar */
.hint-bar {
  display: flex;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  align-items: center;
  background: var(--beige);
  border-bottom: 2px solid var(--beige-darker);
  flex-wrap: wrap;
  position: relative;
  z-index: 1050;
}
.hint-label {
  font-family: 'Fredoka One', cursive;
  font-size: 0.85rem;
  color: var(--ink-light);
}
.hint-chip {
  font-family: 'Fredoka One', cursive;
  font-size: 0.78rem;
  padding: 0.2rem 0.65rem;
  border-radius: 20px;
  border: 2px solid var(--ink);
  background: var(--cream);
  cursor: pointer;
  transition: background 0.15s, transform 0.1s;
}
.hint-chip:hover { background: var(--yellow); transform: scale(1.05); }
.hint-chip:disabled, .hint-chip.used {
  opacity: 0.45;
  cursor: not-allowed;
  transform: none;
}

.hint-text {
  font-size: 0.82rem;
  color: var(--blue);
  font-weight: 700;
  margin-left: auto;
  animation: fadeIn 0.3s ease both;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: none; } }

/* Progress dots */
.progress-dots {
  display: flex;
  gap: 5px;
  padding: 0.5rem 1rem;
  justify-content: center;
  background: var(--beige);
  border-bottom: 2px solid var(--beige-darker);
  position: relative;
  z-index: 1050;
}
.progress-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid var(--ink);
  background: var(--cream);
  transition: background 0.3s, transform 0.2s;
}
.progress-dot.done { background: var(--green); transform: scale(1.15); }
.progress-dot.current { background: var(--yellow); transform: scale(1.2); animation: pulse 1s ease infinite; }
@keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(247,201,72,0.5)} 50%{box-shadow:0 0 0 5px rgba(247,201,72,0)} }

/* â”€â”€ END SCREEN â”€â”€ */
#endScreen {
  align-items: center;
  justify-content: center;
  padding: 2rem 1.5rem;
  text-align: center;
}

.end-trophy {
  font-size: 5rem;
  animation: trophyBounce 1s cubic-bezier(.34,1.56,.64,1) both;
  margin-bottom: 0.5rem;
}
@keyframes trophyBounce {
  from { transform: scale(0.3) translateY(40px); opacity: 0; }
  to   { transform: scale(1) translateY(0); opacity: 1; }
}

.end-title {
  font-family: 'Fredoka One', cursive;
  font-size: clamp(1.8rem, 6vw, 2.8rem);
  color: var(--ink);
  margin-bottom: 0.3rem;
}
.end-final-score {
  font-family: 'Fredoka One', cursive;
  font-size: clamp(2.5rem, 9vw, 4rem);
  color: var(--blue);
  margin-bottom: 0.3rem;
}
.end-rank {
  font-size: 1rem;
  color: var(--ink-light);
  font-weight: 700;
  margin-bottom: 1.5rem;
}

.score-breakdown {
  width: 100%;
  max-width: 500px;
  background: var(--cream);
  border: 3px solid var(--ink);
  border-radius: 20px;
  overflow: hidden;
  margin-bottom: 1.5rem;
  box-shadow: 4px 4px 0 var(--ink);
}
.breakdown-header {
  background: var(--ink);
  color: var(--cream);
  font-family: 'Fredoka One', cursive;
  font-size: 0.95rem;
  padding: 0.5rem 1rem;
  text-align: left;
}
.breakdown-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.45rem 1rem;
  border-bottom: 1.5px solid var(--beige-dark);
  gap: 0.5rem;
  animation: slideIn 0.3s ease both;
}
.breakdown-row:last-child { border-bottom: none; }
@keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: none; } }
.breakdown-name {
  font-weight: 700;
  font-size: 0.85rem;
  flex: 1;
  text-align: left;
}
.breakdown-dist {
  font-size: 0.78rem;
  color: var(--ink-light);
  font-weight: 700;
  text-align: right;
}
.breakdown-pts {
  font-family: 'Fredoka One', cursive;
  font-size: 1rem;
  min-width: 55px;
  text-align: right;
  padding: 0.1rem 0.5rem;
  border-radius: 12px;
}
.breakdown-pts.pts-perfect { background: #a8f0b0; }
.breakdown-pts.pts-great   { background: #fef3c2; }
.breakdown-pts.pts-ok      { background: #ffd4a0; }
.breakdown-pts.pts-poor    { background: #ffc0c0; }

.end-actions {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  justify-content: center;
}
.btn-primary {
  font-family: 'Fredoka One', cursive;
  font-size: 1.15rem;
  padding: 0.7rem 2rem;
  background: var(--green);
  color: white;
  border: 3px solid var(--ink);
  border-radius: 40px;
  cursor: pointer;
  box-shadow: 4px 4px 0 var(--ink);
  transition: transform 0.18s cubic-bezier(.34,1.56,.64,1), box-shadow 0.15s;
}
.btn-primary:hover { transform: translateY(-3px) scale(1.04); box-shadow: 4px 4px 0 var(--ink), 0 0 18px rgba(92,187,111,0.5); }

.btn-secondary {
  font-family: 'Fredoka One', cursive;
  font-size: 1.15rem;
  padding: 0.7rem 2rem;
  background: var(--cream);
  color: var(--ink);
  border: 3px solid var(--ink);
  border-radius: 40px;
  cursor: pointer;
  box-shadow: 4px 4px 0 var(--ink);
  transition: transform 0.18s cubic-bezier(.34,1.56,.64,1);
}
.btn-secondary:hover { transform: translateY(-3px) scale(1.04); background: var(--beige-darker); }

/* Confetti canvas */
#confettiCanvas {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9999;
}

/* Mobile tweaks */
@media (max-width: 600px) {
  .mode-grid { grid-template-columns: 1fr; max-width: 280px; }
  .question-bar { padding: 0.5rem 0.8rem; }
  .result-overlay { flex-direction: column; align-items: flex-start; }
  .timer-bar-wrap { width: 80px; }
}
@media (max-width: 768px) {
  .mode-grid { grid-template-columns: repeat(3, 1fr); }
}
</style>
</head>
<body>

<canvas id="confettiCanvas"></canvas>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-left">
    <a href="../" class="back-btn">â† Home</a>
    <div class="game-title">ğŸŒ Geo Guesser</div>
  </div>
  <div class="topbar-stats" id="topbarStats" style="display:none">
    <div class="stat-chip score-chip">â­ <span id="statScore">0</span></div>
    <div class="stat-chip round-chip">Round <span id="statRound">1</span>/10</div>
    <div class="stat-chip streak-chip">ğŸ”¥ <span id="statStreak">0</span></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â• START SCREEN â•â•â•â•â•â•â• -->
<div id="startScreen" class="screen active">
  <div class="start-globe">ğŸŒ</div>
  <h1 class="start-title">Geo <span>Guesser</span></h1>
  <p class="start-sub">Click the map to place where you think it is!</p>

  <div class="mode-grid">
    <div class="mode-card m-states" data-mode="states" onclick="selectMode('states')">
      <div class="mode-emoji">ğŸ—ºï¸</div>
      <div class="mode-label">US States</div>
      <div class="mode-desc">50 states on the US map</div>
    </div>
    <div class="mode-card m-cities" data-mode="cities" onclick="selectMode('cities')">
      <div class="mode-emoji">ğŸ™ï¸</div>
      <div class="mode-label">US Cities</div>
      <div class="mode-desc">Major American cities</div>
    </div>
    <div class="mode-card m-world" data-mode="world" onclick="selectMode('world')">
      <div class="mode-emoji">ğŸŒ</div>
      <div class="mode-label">Countries</div>
      <div class="mode-desc">Nations of the world</div>
    </div>
  </div>

  <div class="diff-row">
    <span class="diff-label">Rounds:</span>
    <button class="diff-btn active" onclick="setRounds(5,this)">5</button>
    <button class="diff-btn" onclick="setRounds(10,this)">10</button>
    <button class="diff-btn" onclick="setRounds(15,this)">15</button>
  </div>

  <button class="start-btn" id="startBtn" onclick="startGame()" disabled>Choose a mode to start!</button>
</div>

<!-- â•â•â•â•â•â•â• GAME SCREEN â•â•â•â•â•â•â• -->
<div id="gameScreen" class="screen">

  <!-- Progress dots -->
  <div class="progress-dots" id="progressDots"></div>

  <!-- Hint bar -->
  <div class="hint-bar">
    <span class="hint-label">ğŸ’¡ Hints:</span>
    <button class="hint-chip" id="hintBtn1" onclick="useHint(1)">Continent / Region</button>
    <button class="hint-chip" id="hintBtn2" onclick="useHint(2)">First Letter</button>
    <div class="hint-text" id="hintText"></div>
  </div>

  <!-- Question -->
  <div class="question-bar">
    <div class="question-text" id="questionText">Where is <span id="targetName">â€¦</span>?</div>
    <div class="timer-bar-wrap" title="Time remaining">
      <div class="timer-bar-fill" id="timerBar"></div>
    </div>
  </div>

  <!-- Map: Leaflet fills this div; result overlay sits on top -->
  <div class="map-wrap" id="mapWrap">
    <div id="mapContainer"></div>

    <!-- Result overlay â€” outside mapContainer so Leaflet clicks don't reach it -->
    <div class="result-overlay" id="resultOverlay">
      <div class="result-info">
        <div class="result-name" id="resultName"></div>
        <div class="result-detail" id="resultDetail"></div>
      </div>
      <div class="result-score-badge" id="resultBadge"></div>
      <!-- stopPropagation prevents the click from reaching the Leaflet map -->
      <button class="next-btn" id="nextBtn" onclick="nextQuestion(event)">Next â†’</button>
    </div>
  </div>

</div>

<!-- â•â•â•â•â•â•â• END SCREEN â•â•â•â•â•â•â• -->
<div id="endScreen" class="screen">
  <div class="end-trophy" id="endTrophy">ğŸ†</div>
  <div class="end-title" id="endTitle">Great Explorer!</div>
  <div class="end-final-score" id="endFinalScore">0 pts</div>
  <div class="end-rank" id="endRank"></div>

  <div class="score-breakdown" id="scoreBreakdown">
    <div class="breakdown-header">ğŸ“‹ Round by Round</div>
    <div id="breakdownRows"></div>
  </div>

  <div class="end-actions">
    <button class="btn-primary" onclick="startGame()">Play Again</button>
    <button class="btn-secondary" onclick="showStart()">Change Mode</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA SETS  (all positions as real lat/lng)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const US_STATES = [
  { name:"Alabama",        lat:32.8,  lng:-86.8,  region:"Southeast" },
  { name:"Alaska",         lat:64.2,  lng:-153.0, region:"Far West" },
  { name:"Arizona",        lat:34.3,  lng:-111.1, region:"Southwest" },
  { name:"Arkansas",       lat:34.9,  lng:-92.4,  region:"South Central" },
  { name:"California",     lat:36.8,  lng:-119.4, region:"West Coast" },
  { name:"Colorado",       lat:39.0,  lng:-105.5, region:"Mountain West" },
  { name:"Connecticut",    lat:41.6,  lng:-72.7,  region:"New England" },
  { name:"Delaware",       lat:39.0,  lng:-75.5,  region:"Mid-Atlantic" },
  { name:"Florida",        lat:27.8,  lng:-81.6,  region:"Southeast" },
  { name:"Georgia",        lat:32.7,  lng:-83.2,  region:"Southeast" },
  { name:"Hawaii",         lat:20.9,  lng:-157.0, region:"Pacific" },
  { name:"Idaho",          lat:44.4,  lng:-114.6, region:"Northwest" },
  { name:"Illinois",       lat:40.0,  lng:-89.2,  region:"Midwest" },
  { name:"Indiana",        lat:39.8,  lng:-86.1,  region:"Midwest" },
  { name:"Iowa",           lat:42.1,  lng:-93.5,  region:"Midwest" },
  { name:"Kansas",         lat:38.5,  lng:-98.4,  region:"Great Plains" },
  { name:"Kentucky",       lat:37.5,  lng:-85.3,  region:"Southeast" },
  { name:"Louisiana",      lat:31.2,  lng:-91.8,  region:"South" },
  { name:"Maine",          lat:45.4,  lng:-69.0,  region:"New England" },
  { name:"Maryland",       lat:39.0,  lng:-76.8,  region:"Mid-Atlantic" },
  { name:"Massachusetts",  lat:42.3,  lng:-71.8,  region:"New England" },
  { name:"Michigan",       lat:44.2,  lng:-85.4,  region:"Great Lakes" },
  { name:"Minnesota",      lat:46.4,  lng:-93.1,  region:"Upper Midwest" },
  { name:"Mississippi",    lat:32.7,  lng:-89.7,  region:"South" },
  { name:"Missouri",       lat:38.5,  lng:-92.5,  region:"Midwest" },
  { name:"Montana",        lat:47.0,  lng:-109.6, region:"Mountain West" },
  { name:"Nebraska",       lat:41.5,  lng:-99.9,  region:"Great Plains" },
  { name:"Nevada",         lat:39.3,  lng:-116.6, region:"West" },
  { name:"New Hampshire",  lat:43.7,  lng:-71.6,  region:"New England" },
  { name:"New Jersey",     lat:40.1,  lng:-74.4,  region:"Mid-Atlantic" },
  { name:"New Mexico",     lat:34.5,  lng:-106.0, region:"Southwest" },
  { name:"New York",       lat:42.2,  lng:-74.8,  region:"Mid-Atlantic" },
  { name:"North Carolina", lat:35.6,  lng:-79.8,  region:"Southeast" },
  { name:"North Dakota",   lat:47.5,  lng:-100.5, region:"Great Plains" },
  { name:"Ohio",           lat:40.4,  lng:-82.8,  region:"Midwest" },
  { name:"Oklahoma",       lat:35.6,  lng:-96.9,  region:"South Central" },
  { name:"Oregon",         lat:44.0,  lng:-120.5, region:"Pacific Northwest" },
  { name:"Pennsylvania",   lat:40.9,  lng:-77.8,  region:"Mid-Atlantic" },
  { name:"Rhode Island",   lat:41.7,  lng:-71.5,  region:"New England" },
  { name:"South Carolina", lat:33.9,  lng:-80.9,  region:"Southeast" },
  { name:"South Dakota",   lat:44.4,  lng:-100.2, region:"Great Plains" },
  { name:"Tennessee",      lat:35.9,  lng:-86.4,  region:"Southeast" },
  { name:"Texas",          lat:31.1,  lng:-97.6,  region:"South Central" },
  { name:"Utah",           lat:39.3,  lng:-111.1, region:"Mountain West" },
  { name:"Vermont",        lat:44.0,  lng:-72.7,  region:"New England" },
  { name:"Virginia",       lat:37.9,  lng:-78.7,  region:"Mid-Atlantic" },
  { name:"Washington",     lat:47.4,  lng:-120.5, region:"Pacific Northwest" },
  { name:"West Virginia",  lat:38.7,  lng:-80.6,  region:"Mid-Atlantic" },
  { name:"Wisconsin",      lat:44.3,  lng:-89.8,  region:"Midwest" },
  { name:"Wyoming",        lat:43.0,  lng:-107.6, region:"Mountain West" },
];

const US_CITIES = [
  { name:"New York City",   lat:40.71, lng:-74.00,  region:"Northeast",        fact:"Most populous US city" },
  { name:"Los Angeles",     lat:34.05, lng:-118.24, region:"West Coast",        fact:"2nd most populous city" },
  { name:"Chicago",         lat:41.88, lng:-87.63,  region:"Midwest",           fact:"The Windy City" },
  { name:"Houston",         lat:29.76, lng:-95.37,  region:"South Texas",       fact:"Space City" },
  { name:"Phoenix",         lat:33.45, lng:-112.07, region:"Southwest",         fact:"Valley of the Sun" },
  { name:"Philadelphia",    lat:39.95, lng:-75.17,  region:"Mid-Atlantic",      fact:"City of Brotherly Love" },
  { name:"San Antonio",     lat:29.42, lng:-98.49,  region:"South Texas",       fact:"Near the Alamo" },
  { name:"San Diego",       lat:32.72, lng:-117.16, region:"West Coast",        fact:"America's Finest City" },
  { name:"Dallas",          lat:32.78, lng:-96.80,  region:"South Central",     fact:"Big D" },
  { name:"San Jose",        lat:37.34, lng:-121.89, region:"West Coast",        fact:"Silicon Valley hub" },
  { name:"Austin",          lat:30.27, lng:-97.74,  region:"South Central",     fact:"Keep Austin Weird!" },
  { name:"Jacksonville",    lat:30.33, lng:-81.66,  region:"Southeast",         fact:"Largest city by area" },
  { name:"Fort Worth",      lat:32.72, lng:-97.32,  region:"South Central",     fact:"Cowtown" },
  { name:"Columbus",        lat:39.96, lng:-82.99,  region:"Midwest",           fact:"Ohio capital" },
  { name:"Charlotte",       lat:35.23, lng:-80.84,  region:"Southeast",         fact:"Queen City" },
  { name:"Indianapolis",    lat:39.77, lng:-86.16,  region:"Midwest",           fact:"Indy 500!" },
  { name:"San Francisco",   lat:37.77, lng:-122.42, region:"West Coast",        fact:"The Golden Gate city" },
  { name:"Seattle",         lat:47.61, lng:-122.33, region:"Pacific Northwest", fact:"Emerald City" },
  { name:"Denver",          lat:39.74, lng:-104.98, region:"Mountain West",     fact:"Mile High City" },
  { name:"Nashville",       lat:36.17, lng:-86.78,  region:"Southeast",         fact:"Music City" },
  { name:"Oklahoma City",   lat:35.47, lng:-97.52,  region:"South Central",     fact:"OKC" },
  { name:"El Paso",         lat:31.76, lng:-106.49, region:"Southwest",         fact:"Sun City" },
  { name:"Boston",          lat:42.36, lng:-71.06,  region:"New England",       fact:"Cradle of Liberty" },
  { name:"Portland",        lat:45.52, lng:-122.68, region:"Pacific Northwest", fact:"City of Roses" },
  { name:"Las Vegas",       lat:36.17, lng:-115.14, region:"Southwest",         fact:"Entertainment capital" },
  { name:"Memphis",         lat:35.15, lng:-90.05,  region:"Southeast",         fact:"Home of the Blues" },
  { name:"Atlanta",         lat:33.75, lng:-84.39,  region:"Southeast",         fact:"The ATL" },
  { name:"Miami",           lat:25.77, lng:-80.19,  region:"Southeast",         fact:"Magic City" },
  { name:"Minneapolis",     lat:44.98, lng:-93.27,  region:"Midwest",           fact:"City of Lakes" },
  { name:"New Orleans",     lat:29.95, lng:-90.07,  region:"South",             fact:"The Big Easy" },
];

const WORLD_COUNTRIES = [
  { name:"Afghanistan",    lat:33,   lng:65,    region:"Asia" },
  { name:"Argentina",      lat:-34,  lng:-64,   region:"South America" },
  { name:"Australia",      lat:-25,  lng:133,   region:"Oceania" },
  { name:"Austria",        lat:47,   lng:14,    region:"Europe" },
  { name:"Bangladesh",     lat:24,   lng:90,    region:"Asia" },
  { name:"Belgium",        lat:50,   lng:4,     region:"Europe" },
  { name:"Bolivia",        lat:-17,  lng:-65,   region:"South America" },
  { name:"Brazil",         lat:-10,  lng:-55,   region:"South America" },
  { name:"Cambodia",       lat:13,   lng:105,   region:"Asia" },
  { name:"Canada",         lat:56,   lng:-96,   region:"North America" },
  { name:"Chile",          lat:-35,  lng:-71,   region:"South America" },
  { name:"China",          lat:35,   lng:105,   region:"Asia" },
  { name:"Colombia",       lat:4,    lng:-72,   region:"South America" },
  { name:"Cuba",           lat:22,   lng:-79,   region:"Caribbean" },
  { name:"Czech Republic", lat:50,   lng:15,    region:"Europe" },
  { name:"Denmark",        lat:56,   lng:10,    region:"Europe" },
  { name:"Ecuador",        lat:-2,   lng:-77,   region:"South America" },
  { name:"Egypt",          lat:26,   lng:30,    region:"Africa" },
  { name:"Ethiopia",       lat:9,    lng:40,    region:"Africa" },
  { name:"Finland",        lat:64,   lng:26,    region:"Europe" },
  { name:"France",         lat:46,   lng:2,     region:"Europe" },
  { name:"Germany",        lat:51,   lng:10,    region:"Europe" },
  { name:"Ghana",          lat:8,    lng:-2,    region:"Africa" },
  { name:"Greece",         lat:39,   lng:22,    region:"Europe" },
  { name:"Guatemala",      lat:15,   lng:-90,   region:"Central America" },
  { name:"Hungary",        lat:47,   lng:19,    region:"Europe" },
  { name:"India",          lat:20,   lng:77,    region:"Asia" },
  { name:"Indonesia",      lat:-5,   lng:120,   region:"Asia" },
  { name:"Iran",           lat:32,   lng:53,    region:"Asia" },
  { name:"Iraq",           lat:33,   lng:44,    region:"Asia" },
  { name:"Ireland",        lat:53,   lng:-8,    region:"Europe" },
  { name:"Israel",         lat:31,   lng:35,    region:"Asia" },
  { name:"Italy",          lat:42,   lng:12,    region:"Europe" },
  { name:"Japan",          lat:36,   lng:138,   region:"Asia" },
  { name:"Jordan",         lat:31,   lng:36,    region:"Asia" },
  { name:"Kazakhstan",     lat:48,   lng:68,    region:"Asia" },
  { name:"Kenya",          lat:1,    lng:38,    region:"Africa" },
  { name:"Madagascar",     lat:-20,  lng:47,    region:"Africa" },
  { name:"Malaysia",       lat:4,    lng:109,   region:"Asia" },
  { name:"Mexico",         lat:23,   lng:-102,  region:"North America" },
  { name:"Morocco",        lat:32,   lng:-5,    region:"Africa" },
  { name:"Mozambique",     lat:-18,  lng:35,    region:"Africa" },
  { name:"Myanmar",        lat:17,   lng:96,    region:"Asia" },
  { name:"Nepal",          lat:28,   lng:84,    region:"Asia" },
  { name:"Netherlands",    lat:52,   lng:5,     region:"Europe" },
  { name:"New Zealand",    lat:-41,  lng:174,   region:"Oceania" },
  { name:"Nigeria",        lat:10,   lng:8,     region:"Africa" },
  { name:"North Korea",    lat:40,   lng:127,   region:"Asia" },
  { name:"Norway",         lat:64,   lng:10,    region:"Europe" },
  { name:"Pakistan",       lat:30,   lng:69,    region:"Asia" },
  { name:"Peru",           lat:-10,  lng:-75,   region:"South America" },
  { name:"Philippines",    lat:13,   lng:122,   region:"Asia" },
  { name:"Poland",         lat:52,   lng:20,    region:"Europe" },
  { name:"Portugal",       lat:39,   lng:-8,    region:"Europe" },
  { name:"Romania",        lat:46,   lng:25,    region:"Europe" },
  { name:"Russia",         lat:60,   lng:100,   region:"Europe/Asia" },
  { name:"Saudi Arabia",   lat:24,   lng:45,    region:"Asia" },
  { name:"South Africa",   lat:-30,  lng:25,    region:"Africa" },
  { name:"South Korea",    lat:36,   lng:128,   region:"Asia" },
  { name:"Spain",          lat:40,   lng:-4,    region:"Europe" },
  { name:"Sri Lanka",      lat:8,    lng:81,    region:"Asia" },
  { name:"Sudan",          lat:15,   lng:30,    region:"Africa" },
  { name:"Sweden",         lat:60,   lng:15,    region:"Europe" },
  { name:"Switzerland",    lat:47,   lng:8,     region:"Europe" },
  { name:"Syria",          lat:35,   lng:38,    region:"Asia" },
  { name:"Taiwan",         lat:24,   lng:121,   region:"Asia" },
  { name:"Tanzania",       lat:-6,   lng:35,    region:"Africa" },
  { name:"Thailand",       lat:15,   lng:101,   region:"Asia" },
  { name:"Turkey",         lat:39,   lng:35,    region:"Asia/Europe" },
  { name:"Uganda",         lat:1,    lng:32,    region:"Africa" },
  { name:"Ukraine",        lat:49,   lng:32,    region:"Europe" },
  { name:"United Kingdom", lat:54,   lng:-2,    region:"Europe" },
  { name:"United States",  lat:38,   lng:-97,   region:"North America" },
  { name:"Uruguay",        lat:-33,  lng:-56,   region:"South America" },
  { name:"Uzbekistan",     lat:41,   lng:64,    region:"Asia" },
  { name:"Venezuela",      lat:8,    lng:-66,   region:"South America" },
  { name:"Vietnam",        lat:16,   lng:107,   region:"Asia" },
  { name:"Yemen",          lat:15,   lng:48,    region:"Asia" },
  { name:"Zambia",         lat:-14,  lng:28,    region:"Africa" },
  { name:"Zimbabwe",       lat:-20,  lng:30,    region:"Africa" },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gameMode = null;
let totalRounds = 5;
let currentRound = 0;
let totalScore = 0;
let currentStreak = 0;
let roundResults = [];
let queue = [];
let currentTarget = null;
let timerInterval = null;
let timerSeconds = 0;
let maxSeconds = 20;
let guessLocked = false;
let hintsUsed = [];

// Leaflet map state
let leafletMap = null;
let guessMarker = null;
let answerMarker = null;
let distancePoly = null;

// Custom pin icons
const PIN_GUESS = L.divIcon({
  className: '',
  html: `<svg width="30" height="40" viewBox="0 0 30 40" style="display:block">
    <path d="M15 0 C7 0 1 6 1 14 C1 24 15 40 15 40 C15 40 29 24 29 14 C29 6 23 0 15 0Z"
          fill="#e8453c" stroke="#3b2f1e" stroke-width="2"/>
    <circle cx="15" cy="14" r="5" fill="white"/>
  </svg>`,
  iconSize: [30, 40],
  iconAnchor: [15, 40],
});

const PIN_ANSWER = L.divIcon({
  className: '',
  html: `<svg width="30" height="40" viewBox="0 0 30 40" style="display:block">
    <path d="M15 0 C7 0 1 6 1 14 C1 24 15 40 15 40 C15 40 29 24 29 14 C29 6 23 0 15 0Z"
          fill="#5cbb6f" stroke="#3b2f1e" stroke-width="2"/>
    <circle cx="15" cy="14" r="5" fill="white"/>
  </svg>`,
  iconSize: [30, 40],
  iconAnchor: [15, 40],
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById('topbarStats').style.display = (id === 'gameScreen') ? 'flex' : 'none';
}

function selectMode(mode) {
  gameMode = mode;
  document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
  document.querySelector(`.mode-card[data-mode="${mode}"]`).classList.add('selected');
  const btn = document.getElementById('startBtn');
  btn.disabled = false;
  const labels = { states:'US States', cities:'US Cities', world:'Countries' };
  btn.textContent = `Start ${labels[mode]}! ğŸš€`;
}

function setRounds(n, el) {
  totalRounds = n;
  document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

function showStart() {
  showScreen('startScreen');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP â€” Leaflet
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMap() {
  // Remove previous map instance
  if (leafletMap) {
    leafletMap.remove();
    leafletMap = null;
    guessMarker = null;
    answerMarker = null;
    distancePoly = null;
  }

  leafletMap = L.map('mapContainer', {
    zoomControl: true,
    attributionControl: true,
    minZoom: 2,
  });

  // CartoDB Voyager tiles â€” no country/city labels so the challenge stays intact
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
    attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> Â© <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 19,
  }).addTo(leafletMap);

  setMapView();

  leafletMap.on('click', function (e) {
    if (guessLocked) return;
    placeGuess(e.latlng.lat, e.latlng.lng);
  });
}

function setMapView() {
  if (!leafletMap) return;
  if (gameMode === 'world') {
    leafletMap.setView([20, 10], 2);
  } else {
    // Continental US + Alaska/Hawaii visible
    leafletMap.fitBounds([[24, -125], [50, -66]]);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCORING  (real distances via haversine)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function haversineKm(lat1, lng1, lat2, lng2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLng / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function calcScore(distKm) {
  // Within 50 km = perfect; score drops off quadratically
  const maxDist = (gameMode === 'world') ? 10000 : 4000;
  const perfect = 50;
  if (distKm <= perfect) return 1000;
  const raw = Math.max(0, 1 - (distKm - perfect) / (maxDist - perfect));
  return Math.round(raw * raw * 900);
}

function scoreLabel(pts) {
  if (pts >= 950) return { label:'ğŸ¯ Perfect!', cls:'perfect' };
  if (pts >= 700) return { label:'â­ Great!',   cls:'great' };
  if (pts >= 400) return { label:'ğŸ‘ OK',        cls:'ok' };
  return                 { label:'ğŸ“ Off',       cls:'poor' };
}

function distanceDisplay(distKm) {
  if (distKm < 5) return 'Spot on!';
  if (gameMode === 'world') {
    if (distKm < 100) return `~${Math.round(distKm)} km away`;
    return `~${Math.round(distKm / 100) * 100} km away`;
  } else {
    const mi = distKm * 0.621371;
    if (mi < 20) return `~${Math.round(mi)} miles away`;
    return `~${Math.round(mi / 50) * 50} miles away`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame() {
  if (!gameMode) return;

  const pool = gameMode === 'states' ? US_STATES
             : gameMode === 'cities' ? US_CITIES
             : WORLD_COUNTRIES;

  queue = shuffle([...pool]).slice(0, totalRounds);
  currentRound = 0;
  totalScore = 0;
  currentStreak = 0;
  roundResults = [];

  showScreen('gameScreen');
  buildProgressDots();
  updateStats();

  // Defer map init one frame so the gameScreen div is visible and sized
  requestAnimationFrame(() => {
    initMap();
    loadQuestion();
  });
}

function buildProgressDots() {
  const el = document.getElementById('progressDots');
  el.innerHTML = '';
  for (let i = 0; i < totalRounds; i++) {
    const d = document.createElement('div');
    d.className = 'progress-dot' + (i === 0 ? ' current' : '');
    d.id = `dot-${i}`;
    el.appendChild(d);
  }
}

function updateProgressDots() {
  for (let i = 0; i < totalRounds; i++) {
    const d = document.getElementById(`dot-${i}`);
    if (!d) continue;
    d.className = 'progress-dot';
    if (i < currentRound) d.classList.add('done');
    else if (i === currentRound) d.classList.add('current');
  }
}

function updateStats() {
  document.getElementById('statScore').textContent = totalScore.toLocaleString();
  document.getElementById('statRound').textContent = currentRound + 1;
  document.getElementById('statStreak').textContent = currentStreak;
}

function loadQuestion() {
  if (currentRound >= totalRounds) { showEndScreen(); return; }

  currentTarget = queue[currentRound];
  guessLocked = false;
  hintsUsed = [];

  // Clear previous markers and line
  if (guessMarker)  { leafletMap.removeLayer(guessMarker);  guessMarker  = null; }
  if (answerMarker) { leafletMap.removeLayer(answerMarker); answerMarker = null; }
  if (distancePoly) { leafletMap.removeLayer(distancePoly); distancePoly = null; }

  // Reset UI
  document.getElementById('resultOverlay').classList.remove('show');
  document.getElementById('hintText').textContent = '';
  document.getElementById('hintBtn1').classList.remove('used');
  document.getElementById('hintBtn2').classList.remove('used');
  document.getElementById('hintBtn1').disabled = false;
  document.getElementById('hintBtn2').disabled = false;
  document.getElementById('targetName').textContent = currentTarget.name;

  // Reset map to full view so every round starts fresh
  setMapView();

  updateProgressDots();
  updateStats();
  startTimer();
}

function startTimer() {
  clearInterval(timerInterval);
  timerSeconds = maxSeconds;
  const bar = document.getElementById('timerBar');
  bar.style.width = '100%';
  bar.className = 'timer-bar-fill';

  timerInterval = setInterval(() => {
    timerSeconds--;
    const pct = (timerSeconds / maxSeconds) * 100;
    bar.style.width = pct + '%';
    if (pct < 33) bar.className = 'timer-bar-fill danger';
    else if (pct < 60) bar.className = 'timer-bar-fill warn';

    if (timerSeconds <= 0) {
      clearInterval(timerInterval);
      if (!guessLocked) timeUp();
    }
  }, 1000);
}

function timeUp() {
  guessLocked = true;
  revealAnswer(null, null);
}

function placeGuess(lat, lng) {
  guessLocked = true;
  clearInterval(timerInterval);

  if (guessMarker) leafletMap.removeLayer(guessMarker);
  guessMarker = L.marker([lat, lng], { icon: PIN_GUESS }).addTo(leafletMap);

  revealAnswer(lat, lng);
}

function revealAnswer(guessLat, guessLng) {
  guessLocked = true;
  const target = currentTarget;

  // Place green answer pin
  if (answerMarker) leafletMap.removeLayer(answerMarker);
  answerMarker = L.marker([target.lat, target.lng], { icon: PIN_ANSWER }).addTo(leafletMap);

  let pts = 0;
  let distKm = 0;

  if (guessLat !== null) {
    distKm = haversineKm(guessLat, guessLng, target.lat, target.lng);
    pts = calcScore(distKm);

    // Draw dashed line between guess and answer
    const lineColor = pts >= 700 ? '#5cbb6f' : '#e8453c';
    if (distancePoly) leafletMap.removeLayer(distancePoly);
    distancePoly = L.polyline(
      [[guessLat, guessLng], [target.lat, target.lng]],
      { color: lineColor, weight: 2.5, dashArray: '8, 6', opacity: 0.9 }
    ).addTo(leafletMap);

    // Zoom to show both pins
    const bounds = L.latLngBounds([[guessLat, guessLng], [target.lat, target.lng]]);
    leafletMap.fitBounds(bounds, { padding: [70, 70], maxZoom: 8 });
  } else {
    // Time's up â€” pan to correct answer
    leafletMap.setView([target.lat, target.lng], 4);
  }

  // Streak bonus
  if (pts >= 400) {
    currentStreak++;
    if (currentStreak >= 3) pts = Math.round(pts * 1.1);
  } else {
    currentStreak = 0;
  }

  totalScore += pts;
  roundResults.push({ name: target.name, pts, distKm, guessLat, guessLng });
  updateStats();

  // Result overlay
  const sl = scoreLabel(pts);
  document.getElementById('resultName').textContent = target.name;

  if (guessLat === null) {
    document.getElementById('resultDetail').textContent =
      `â±ï¸ Time's up! It was in ${target.region}`;
  } else {
    document.getElementById('resultDetail').textContent =
      `${distanceDisplay(distKm)} Â· ${target.region}${currentStreak >= 3 ? ' ğŸ”¥ Streak bonus!' : ''}`;
  }

  const badge = document.getElementById('resultBadge');
  badge.textContent = `${sl.label} ${pts > 0 ? pts.toLocaleString() + ' pts' : ''}`;
  badge.className = `result-score-badge ${sl.cls}`;
  document.getElementById('resultOverlay').classList.add('show');

  document.getElementById('nextBtn').textContent =
    currentRound < totalRounds - 1 ? 'Next â†’' : 'See Results!';
}

function nextQuestion(event) {
  // Stop the click from reaching the Leaflet map underneath the overlay
  if (event) event.stopPropagation();

  currentRound++;
  if (currentRound >= totalRounds) {
    showEndScreen();
  } else {
    loadQuestion();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function useHint(n) {
  if (guessLocked) return;
  if (hintsUsed.includes(n)) return;
  hintsUsed.push(n);
  const btn = document.getElementById(`hintBtn${n}`);
  btn.classList.add('used');
  btn.disabled = true;

  const t = currentTarget;
  let hint = '';
  if (n === 1) {
    hint = `ğŸ“ Region: ${t.region}`;
  } else if (n === 2) {
    hint = `ğŸ”¤ Starts with: "${t.name[0]}"`;
    if (t.fact) hint += ` Â· ${t.fact}`;
  }

  document.getElementById('hintText').textContent = hint;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// END SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showEndScreen() {
  clearInterval(timerInterval);
  showScreen('endScreen');

  const maxPts = totalRounds * 1000;
  const pct = totalScore / maxPts;

  let trophy = 'ğŸ†', title = 'Great Explorer!';
  if      (pct >= 0.9)  { trophy = 'ğŸ¥‡'; title = 'Geography Master!'; }
  else if (pct >= 0.75) { trophy = 'ğŸ†'; title = 'Great Explorer!'; }
  else if (pct >= 0.5)  { trophy = 'ğŸ¥ˆ'; title = 'Getting There!'; }
  else if (pct >= 0.25) { trophy = 'ğŸ¥‰'; title = 'Keep Exploring!'; }
  else                  { trophy = 'ğŸ—ºï¸'; title = 'Time to Study!'; }

  document.getElementById('endTrophy').textContent = trophy;
  document.getElementById('endTitle').textContent = title;
  document.getElementById('endFinalScore').textContent = totalScore.toLocaleString() + ' pts';

  const rankLabels = [
    { min: 0.9,  label: 'ğŸŒŸ World-class navigator' },
    { min: 0.75, label: 'âœˆï¸ Seasoned traveler' },
    { min: 0.5,  label: 'ğŸ§­ Curious explorer' },
    { min: 0.25, label: 'ğŸ—ºï¸ Rookie cartographer' },
    { min: 0,    label: 'ğŸ“š Keep studying!' },
  ];
  document.getElementById('endRank').textContent = rankLabels.find(r => pct >= r.min).label;

  const rows = document.getElementById('breakdownRows');
  rows.innerHTML = '';
  roundResults.forEach((r, i) => {
    const sl = scoreLabel(r.pts);
    const row = document.createElement('div');
    row.className = 'breakdown-row';
    row.style.animationDelay = (i * 0.07) + 's';
    row.innerHTML = `
      <span class="breakdown-name">${i + 1}. ${r.name}</span>
      <span class="breakdown-dist">${r.guessLat !== null ? distanceDisplay(r.distKm) : "Time's up"}</span>
      <span class="breakdown-pts pts-${sl.cls}">${r.pts.toLocaleString()}</span>
    `;
    rows.appendChild(row);
  });

  if (pct >= 0.75) launchConfetti();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFETTI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function launchConfetti() {
  const canvas = document.getElementById('confettiCanvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const colors = ['#f7c948','#5cbb6f','#4a90d9','#e8453c','#9b6fda','#f5832a','#e8668a','#3dbfb0'];
  const pieces = Array.from({length: 120}, () => ({
    x: Math.random() * canvas.width,
    y: Math.random() * -canvas.height,
    r: 4 + Math.random() * 6,
    color: colors[Math.floor(Math.random() * colors.length)],
    vx: (Math.random() - 0.5) * 3,
    vy: 2 + Math.random() * 4,
    rot: Math.random() * 360,
    rotV: (Math.random() - 0.5) * 8,
    shape: Math.random() > 0.5 ? 'rect' : 'circle'
  }));

  let frame = 0;
  function draw() {
    if (frame > 200) { ctx.clearRect(0, 0, canvas.width, canvas.height); return; }
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    pieces.forEach(p => {
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot * Math.PI / 180);
      ctx.fillStyle = p.color;
      ctx.globalAlpha = Math.max(0, 1 - frame / 180);
      if (p.shape === 'circle') {
        ctx.beginPath(); ctx.arc(0, 0, p.r, 0, Math.PI * 2); ctx.fill();
      } else {
        ctx.fillRect(-p.r, -p.r / 2, p.r * 2, p.r);
      }
      ctx.restore();
      p.x += p.vx; p.y += p.vy; p.rot += p.rotV; p.vy += 0.05;
    });
    frame++;
    requestAnimationFrame(draw);
  }
  draw();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
</script>
</body>
</html>
