<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ğŸš€ Asteroid Addition</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Nunito:wght@700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{width:100%;height:100%;overflow:hidden;background:#000;}
body{font-family:'Nunito',sans-serif;touch-action:none;}

#gameWrap{
  position:relative;width:100%;height:100%;
  background:radial-gradient(ellipse at 50% 30%,#0d1b3e 0%,#050a1a 60%,#000 100%);
  overflow:hidden;
}

/* STARS */
#starfield{position:absolute;inset:0;pointer-events:none;}
.star{position:absolute;border-radius:50%;background:white;animation:twinkle var(--d,3s) ease-in-out infinite var(--delay,0s);}
@keyframes twinkle{0%,100%{opacity:var(--minO,.2);transform:scale(1)}50%{opacity:1;transform:scale(1.4)}}

/* NEBULA BG */
#gameWrap::before{
  content:'';position:absolute;inset:0;pointer-events:none;
  background:
    radial-gradient(ellipse 60% 40% at 15% 25%,rgba(100,20,180,.18) 0%,transparent 70%),
    radial-gradient(ellipse 50% 35% at 85% 60%,rgba(20,80,180,.15) 0%,transparent 70%),
    radial-gradient(ellipse 40% 30% at 50% 80%,rgba(180,40,40,.08) 0%,transparent 70%);
}

/* HUD TOP */
#hud{
  position:absolute;top:0;left:0;right:0;z-index:10;
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 16px 8px;
  background:linear-gradient(to bottom,rgba(0,0,0,.7) 0%,transparent 100%);
}
.hud-block{display:flex;flex-direction:column;align-items:center;}
.hud-lbl{font-family:'Orbitron',monospace;font-size:.5rem;color:rgba(100,200,255,.6);letter-spacing:.12em;text-transform:uppercase;margin-bottom:2px;}
.hud-val{font-family:'Orbitron',monospace;font-size:1.3rem;color:#fff;font-weight:700;}
.hud-val.score{color:#FFD93D;}
.hud-val.best{color:#9B7FD4;}
#livesDisplay{display:flex;gap:5px;font-size:1.4rem;margin-top:2px;}
#levelBadge{
  font-family:'Orbitron',monospace;font-size:.62rem;font-weight:700;
  background:linear-gradient(135deg,#1a4a8a,#2a7aff);
  border:1px solid rgba(100,180,255,.4);
  border-radius:99px;padding:5px 14px;color:#7df;letter-spacing:.08em;
}

/* CANVAS */
#gameCanvas{position:absolute;inset:0;width:100%;height:100%;}

/* BOTTOM HUD */
#bottomHud{
  position:absolute;bottom:0;left:0;right:0;z-index:10;
  background:linear-gradient(to top,rgba(0,0,20,.9) 0%,rgba(0,0,20,.7) 60%,transparent 100%);
  padding:8px 14px 14px;
}
#equationWrap{
  display:flex;align-items:center;gap:0;overflow:hidden;
  margin-bottom:6px;height:28px;
  mask-image:linear-gradient(to right,transparent 0%,black 15%,black 100%);
  -webkit-mask-image:linear-gradient(to right,transparent 0%,black 15%,black 100%);
}
#equationScroll{
  display:flex;align-items:center;gap:0;
  transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  white-space:nowrap;
}
.eq-num{
  font-family:'Orbitron',monospace;font-size:1.1rem;font-weight:700;
  padding:0 3px;
  animation:eqPop .35s cubic-bezier(.34,1.56,.64,1);
}
.eq-plus{font-family:'Orbitron',monospace;font-size:.9rem;color:rgba(255,255,255,.4);padding:0 1px;}
@keyframes eqPop{from{transform:scale(1.6) translateY(-4px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
#eqTotal{
  font-family:'Orbitron',monospace;font-size:1.1rem;font-weight:900;
  color:#FFD93D;padding:0 6px;border-left:1px solid rgba(255,255,255,.2);margin-left:4px;
  animation:totalPulse .3s ease;
}
@keyframes totalPulse{0%{transform:scale(1.3)}100%{transform:scale(1)}}

#dodgeRow{display:flex;align-items:center;justify-content:space-between;}
#dodgeCount{font-family:'Orbitron',monospace;font-size:.75rem;color:rgba(100,200,255,.7);letter-spacing:.06em;}
#totalBig{font-family:'Orbitron',monospace;font-size:1.6rem;font-weight:900;color:#FFD93D;letter-spacing:.04em;}

/* SCREENS */
.overlay{
  position:absolute;inset:0;z-index:50;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:rgba(0,0,10,.85);backdrop-filter:blur(4px);
  padding:20px;
}
.overlay.hidden{display:none;}

.game-card{
  background:linear-gradient(135deg,#0a1628,#0d2040);
  border:1px solid rgba(100,180,255,.25);
  border-radius:24px;padding:32px 28px;max-width:380px;width:100%;text-align:center;
  box-shadow:0 0 60px rgba(40,120,255,.2),0 20px 60px rgba(0,0,0,.5);
}
.game-title{font-family:'Orbitron',monospace;font-size:clamp(1.6rem,5vw,2.4rem);font-weight:900;color:#FFD93D;margin-bottom:4px;letter-spacing:.06em;}
.game-subtitle{font-family:'Orbitron',monospace;font-size:.7rem;color:#7df;letter-spacing:.15em;text-transform:uppercase;margin-bottom:20px;}
.game-ship{font-size:4rem;margin:8px 0 16px;animation:shipHover 2s ease-in-out infinite;}
@keyframes shipHover{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}

.big-btn{
  background:linear-gradient(135deg,#1a5aff,#0a3adf);
  border:none;border-radius:99px;padding:16px 40px;
  font-family:'Orbitron',monospace;font-size:1rem;font-weight:700;color:white;
  cursor:pointer;transition:all .18s;letter-spacing:.08em;
  box-shadow:0 0 30px rgba(30,100,255,.4),0 4px 16px rgba(0,0,0,.3);
  margin:6px 0;width:100%;
}
.big-btn:active{transform:scale(.96);}
.big-btn.green{background:linear-gradient(135deg,#1a9a4a,#0a7a32);box-shadow:0 0 30px rgba(30,180,80,.4),0 4px 16px rgba(0,0,0,.3);}
.big-btn.orange{background:linear-gradient(135deg,#d06010,#a04000);box-shadow:0 0 30px rgba(200,100,20,.4),0 4px 16px rgba(0,0,0,.3);}

.stat-row{display:flex;justify-content:space-around;margin:16px 0;}
.stat-box{display:flex;flex-direction:column;align-items:center;gap:3px;}
.stat-lbl{font-family:'Orbitron',monospace;font-size:.5rem;color:rgba(100,200,255,.5);letter-spacing:.1em;text-transform:uppercase;}
.stat-val{font-family:'Orbitron',monospace;font-size:1.4rem;font-weight:900;color:#FFD93D;}
.stat-val.purple{color:#C77DFF;}

.how-to{background:rgba(255,255,255,.05);border-radius:14px;padding:14px;margin:14px 0;text-align:left;}
.how-to-item{display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:.85rem;color:rgba(255,255,255,.75);font-weight:700;}
.how-to-item:last-child{margin-bottom:0;}

/* VALUE COLOR LEGEND */
.val-colors{display:flex;gap:6px;justify-content:center;margin:10px 0;}
.vc{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-size:.7rem;font-weight:900;color:white;border:2px solid rgba(255,255,255,.3);}

/* COMBO popup */
.combo-popup{
  position:absolute;pointer-events:none;z-index:30;
  font-family:'Orbitron',monospace;font-weight:900;
  text-shadow:0 0 12px currentColor;
  animation:comboPop .8s ease forwards;
}
@keyframes comboPop{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-60px) scale(.8)}}

/* EXPLOSION */
.explosion{position:absolute;pointer-events:none;z-index:25;animation:explode .5s ease forwards;}
@keyframes explode{0%{opacity:1;transform:scale(.5)}50%{opacity:1;transform:scale(1.3)}100%{opacity:0;transform:scale(1.8)}}

/* SPEED ALERT */
#speedAlert{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-family:'Orbitron',monospace;font-size:1.4rem;font-weight:900;color:#ff4444;
  text-shadow:0 0 20px #ff4444;letter-spacing:.1em;
  pointer-events:none;z-index:20;opacity:0;
  animation:none;
}
#speedAlert.show{animation:speedFlash 1.5s ease forwards;}
@keyframes speedFlash{0%{opacity:0;transform:translate(-50%,-50%) scale(.8)}20%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}80%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-50%) scale(.9)}}
</style>
</head>
<body>
<div id="gameWrap">
  <div id="starfield"></div>
  <canvas id="gameCanvas"></canvas>

  <!-- TOP HUD -->
  <div id="hud">
    <div class="hud-block">
      <div class="hud-lbl">Score</div>
      <div class="hud-val score" id="hudScore">0</div>
    </div>
    <div id="levelBadge">LEVEL 1</div>
    <div class="hud-block" style="align-items:flex-end;">
      <div class="hud-lbl">Lives</div>
      <div id="livesDisplay">ğŸš€ğŸš€ğŸš€</div>
    </div>
  </div>

  <!-- BOTTOM HUD -->
  <div id="bottomHud">
    <div id="equationWrap">
      <div id="equationScroll"></div>
      <div id="eqTotal">=0</div>
    </div>
    <div id="dodgeRow">
      <div id="dodgeCount">â˜„ï¸ 0 dodged</div>
      <div id="totalBig">0</div>
    </div>
  </div>

  <div id="speedAlert">âš¡ FASTER! âš¡</div>

  <!-- START SCREEN -->
  <div class="overlay" id="startScreen">
    <div class="game-card">
      <div class="game-title">ASTEROID</div>
      <div class="game-title" style="color:#7df;">ADDITION</div>
      <div class="game-subtitle">A Space Math Adventure</div>
      <div class="game-ship">ğŸš€</div>
      <div class="how-to">
        <div class="how-to-item"><span>ğŸ‘†</span> Drag or tap to move your ship</div>
        <div class="how-to-item"><span>â˜„ï¸</span> Dodge asteroids to add their number</div>
        <div class="how-to-item"><span>ğŸ’¥</span> Don't get hit â€” you have 3 lives!</div>
        <div class="how-to-item"><span>â•</span> Watch your addition grow below!</div>
      </div>
      <div class="val-colors" id="legendColors"></div>
      <div style="font-family:'Orbitron',monospace;font-size:.55rem;color:rgba(100,200,255,.5);letter-spacing:.08em;margin-bottom:14px;">SIZE = VALUE (1 tiny â†’ 5 huge)</div>
      <button class="big-btn green" onclick="startGame()">ğŸš€ LAUNCH!</button>
    </div>
  </div>

  <!-- GAME OVER SCREEN -->
  <div class="overlay hidden" id="gameOverScreen">
    <div class="game-card">
      <div class="game-title" style="color:#ff4444;">GAME</div>
      <div class="game-title" style="color:#ff4444;">OVER</div>
      <div style="font-size:3rem;margin:12px 0;">ğŸ’¥</div>
      <div class="stat-row">
        <div class="stat-box"><div class="stat-lbl">Total</div><div class="stat-val" id="goTotal">0</div></div>
        <div class="stat-box"><div class="stat-lbl">Dodged</div><div class="stat-val" id="goDodged">0</div></div>
        <div class="stat-box"><div class="stat-lbl">Best</div><div class="stat-val purple" id="goBest">0</div></div>
      </div>
      <div id="goEquation" style="font-family:'Orbitron',monospace;font-size:.7rem;color:rgba(100,200,255,.6);margin:8px 0 16px;word-break:break-all;line-height:1.6;"></div>
      <button class="big-btn green" onclick="startGame()">ğŸš€ PLAY AGAIN</button>
      <button class="big-btn" onclick="showStart()" style="margin-top:6px;">â† HOME</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const wrap=document.getElementById('gameWrap');

// value colors â€” 1..5
const VAL_COLORS=['#78C8FF','#7DFF8A','#FFD93D','#FF8C42','#FF4D6D'];
const VAL_GLOW  =['rgba(120,200,255,.6)','rgba(125,255,138,.6)','rgba(255,217,61,.6)','rgba(255,140,66,.6)','rgba(255,77,109,.6)'];

// legend
document.getElementById('legendColors').innerHTML=
  [1,2,3,4,5].map((v,i)=>`<div class="vc" style="background:${VAL_COLORS[i]};box-shadow:0 0 12px ${VAL_GLOW[i]};">${v}</div>`).join('');

// Stars
function buildStars(){
  const sf=document.getElementById('starfield');
  sf.innerHTML='';
  for(let i=0;i<160;i++){
    const s=document.createElement('div');
    s.className='star';
    const sz=Math.random()<.15?2.5:Math.random()<.4?1.5:1;
    s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;
      --d:${2+Math.random()*4}s;--delay:${Math.random()*4}s;--minO:${.1+Math.random()*.3};`;
    sf.appendChild(s);
  }
}
buildStars();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let W,H,DPR;
let ship={x:0,y:0,w:44,h:56,vx:0};
let asteroids=[];
let particles=[];
let lives=3,score=0,dodged=0,level=1,bestScore=0;
let gameActive=false,gameOver=false;
let spawnTimer=0,spawnInterval=120;
let baseSpeed=2.5,speedMult=1;
let eqNums=[]; // running equation numbers
let touchX=null;
let animId=null;
let lastLevel=1;

function resize(){
  DPR=Math.min(window.devicePixelRatio||1,2);
  W=wrap.clientWidth; H=wrap.clientHeight;
  canvas.width=W*DPR; canvas.height=H*DPR;
  canvas.style.width=W+'px'; canvas.style.height=H+'px';
  ctx.scale(DPR,DPR);
  ship.x=W/2; ship.y=H-100;
}
window.addEventListener('resize',()=>{resize();});
resize();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pointerX=null;

canvas.addEventListener('pointermove',e=>{
  if(!gameActive)return;
  pointerX=e.clientX;
},{passive:true});
canvas.addEventListener('pointerdown',e=>{
  if(!gameActive)return;
  pointerX=e.clientX;
},{passive:true});
canvas.addEventListener('pointerup',()=>{pointerX=null;},{passive:true});
canvas.addEventListener('pointercancel',()=>{pointerX=null;},{passive:true});

// also allow tapping anywhere on wrap
wrap.addEventListener('pointermove',e=>{if(gameActive)pointerX=e.clientX;},{passive:true});
wrap.addEventListener('pointerdown',e=>{if(gameActive)pointerX=e.clientX;},{passive:true});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ASTEROID CLASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Asteroid{
  constructor(){
    this.val=Math.floor(Math.random()*5)+1; // 1..5
    this.r=14+this.val*7;  // radius 21..49
    // Zone-based X spawn: divide screen into 5 zones and pick one
    // then randomise within it â€” ensures spread, no permanent safe corners
    const zone=Math.floor(Math.random()*5);
    const zoneW=(W-this.r*2)/5;
    this.x=this.r+zone*zoneW+Math.random()*zoneW;
    this.x=Math.max(this.r,Math.min(W-this.r,this.x));
    this.y=-this.r-10;

    // Speed: ramp up to a screen-height-relative cap so asteroids
    // always spend at least ~0.6s on screen regardless of level
    const MAX_VY=H*0.008; // cap = 0.8% of screen height per frame â‰ˆ ~4.8px/f on 600px
    const rawVY=(baseSpeed*speedMult)*(0.8+Math.random()*.5);
    this.vy=Math.min(rawVY, MAX_VY);

    // Angle: increases with level. Early=nearly straight, late=wild diagonals
    // Also add subtle homing: drift slightly toward ship x at spawn
    const maxAngle=Math.min(0.08+level*0.028, 0.65); // radians converted to vx
    const homingBias=(ship.x-this.x)/(W*1.8); // gentle pull toward ship
    this.vx=(Math.random()-.5)*2*maxAngle*(this.vy)+homingBias*this.vy*0.4;

    this.rot=Math.random()*Math.PI*2;
    this.rotSpeed=(Math.random()-.5)*.04;
    this.pts=this._makeShape();
    this.color=VAL_COLORS[this.val-1];
    this.glow=VAL_GLOW[this.val-1];
    this.dodged=false;
    this.hit=false;
    this.opacity=1;
    // Trail for fast ones
    this.trail=[];
  }
  _makeShape(){
    const pts=[];
    const n=7+this.val; // more sides = bigger = more complex
    for(let i=0;i<n;i++){
      const a=(2*Math.PI*i/n);
      const r=this.r*(0.72+Math.random()*.36);
      pts.push([Math.cos(a)*r,Math.sin(a)*r]);
    }
    return pts;
  }
  draw(){
    ctx.save();
    ctx.translate(this.x,this.y);
    ctx.rotate(this.rot);
    ctx.globalAlpha=this.opacity;

    // glow
    ctx.shadowColor=this.glow;
    ctx.shadowBlur=18+this.val*3;

    // body
    ctx.beginPath();
    this.pts.forEach((p,i)=>i===0?ctx.moveTo(p[0],p[1]):ctx.lineTo(p[0],p[1]));
    ctx.closePath();
    ctx.fillStyle=this.color+'33';
    ctx.fill();
    ctx.strokeStyle=this.color;
    ctx.lineWidth=2.5;
    ctx.stroke();

    // number label
    ctx.shadowBlur=0;
    ctx.fillStyle='white';
    ctx.font=`900 ${10+this.val*3}px Orbitron,monospace`;
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText(this.val,0,0);

    ctx.restore();

    // Speed trail for fast asteroids
    if(this.vy > H*0.005 && this.trail.length>1){
      ctx.save();
      for(let i=1;i<this.trail.length;i++){
        const t=i/this.trail.length;
        ctx.beginPath();
        ctx.strokeStyle=this.color;
        ctx.globalAlpha=t*0.25*this.opacity;
        ctx.lineWidth=(1-t)*this.r*0.5;
        ctx.moveTo(this.trail[i-1][0],this.trail[i-1][1]);
        ctx.lineTo(this.trail[i][0],this.trail[i][1]);
        ctx.stroke();
      }
      ctx.restore();
    }
  }
  update(){
    this.trail.push([this.x,this.y]);
    if(this.trail.length>5) this.trail.shift();
    this.x+=this.vx;
    this.y+=this.vy;
    this.rot+=this.rotSpeed;
    // Bounce off walls
    if(this.x-this.r<0){ this.x=this.r; this.vx=Math.abs(this.vx); }
    if(this.x+this.r>W){ this.x=W-this.r; this.vx=-Math.abs(this.vx); }
  }
  get bottom(){return this.y+this.r;}
  get top(){return this.y-this.r;}
  get left(){return this.x-this.r;}
  get right(){return this.x+this.r;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnParticles(x,y,color,count=12,type='explode'){
  for(let i=0;i<count;i++){
    const a=Math.random()*Math.PI*2;
    const spd=type==='dodge'?1+Math.random()*3:2+Math.random()*5;
    particles.push({
      x,y,
      vx:Math.cos(a)*spd*(type==='dodge'?.5:1),
      vy:Math.sin(a)*spd*(type==='dodge'?.5:1)-(type==='dodge'?2:0),
      r:type==='dodge'?2+Math.random()*3:3+Math.random()*5,
      color,
      life:1,
      decay:type==='dodge'?.025+Math.random()*.02:.04+Math.random()*.04,
      type
    });
  }
}

function updateParticles(){
  particles=particles.filter(p=>{
    p.x+=p.vx; p.y+=p.vy;
    p.vy+=0.1; // gravity
    p.life-=p.decay;
    return p.life>0;
  });
}

function drawParticles(){
  particles.forEach(p=>{
    ctx.save();
    ctx.globalAlpha=p.life;
    ctx.shadowColor=p.color;
    ctx.shadowBlur=8;
    ctx.fillStyle=p.color;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHIP DRAWING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawShip(x,y,flash=false){
  ctx.save();
  ctx.translate(x,y);

  const w=ship.w, h=ship.h;

  // engine glow
  const eg=ctx.createRadialGradient(0,h*.3,0,0,h*.3,w*.8);
  eg.addColorStop(0,'rgba(80,160,255,.7)');
  eg.addColorStop(1,'rgba(80,160,255,0)');
  ctx.fillStyle=eg;
  ctx.beginPath();ctx.arc(0,h*.3,w*.8,0,Math.PI*2);ctx.fill();

  // engine flame
  const flameH=16+Math.random()*10;
  const fl=ctx.createLinearGradient(0,h*.3,0,h*.3+flameH);
  fl.addColorStop(0,'rgba(255,200,80,1)');
  fl.addColorStop(0.5,'rgba(255,100,30,.8)');
  fl.addColorStop(1,'rgba(255,50,0,0)');
  ctx.fillStyle=fl;
  ctx.beginPath();
  ctx.moveTo(-w*.22,h*.3);
  ctx.lineTo(0,h*.3+flameH);
  ctx.lineTo(w*.22,h*.3);
  ctx.closePath();
  ctx.fill();

  // body
  if(flash){ctx.shadowColor='#ff4444';ctx.shadowBlur=30;}
  else{ctx.shadowColor='rgba(100,180,255,.8)';ctx.shadowBlur=20;}

  ctx.fillStyle=flash?'#ff4444':'#1a4adf';
  ctx.beginPath();
  ctx.moveTo(0,-h*.5);        // nose
  ctx.lineTo(w*.38,h*.25);    // right shoulder
  ctx.lineTo(w*.28,h*.5);     // right base
  ctx.lineTo(-w*.28,h*.5);    // left base
  ctx.lineTo(-w*.38,h*.25);   // left shoulder
  ctx.closePath();
  ctx.fill();

  // cockpit
  ctx.fillStyle='rgba(150,220,255,.9)';
  ctx.shadowBlur=10;ctx.shadowColor='#7df';
  ctx.beginPath();
  ctx.ellipse(0,-h*.08,w*.14,h*.18,0,0,Math.PI*2);
  ctx.fill();

  // wing highlights
  ctx.strokeStyle='rgba(100,160,255,.5)';ctx.lineWidth=1.5;ctx.shadowBlur=0;
  ctx.beginPath();ctx.moveTo(w*.38,h*.25);ctx.lineTo(w*.28,h*.5);ctx.stroke();
  ctx.beginPath();ctx.moveTo(-w*.38,h*.25);ctx.lineTo(-w*.28,h*.5);ctx.stroke();

  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let shipFlash=0;

function updateHUD(){
  document.getElementById('hudScore').textContent=score;
  const lv=document.getElementById('levelBadge');
  lv.textContent='LEVEL '+level;
  let lives_html='';
  for(let i=0;i<3;i++) lives_html+=(i<lives?'ğŸš€':'ğŸ’€');
  document.getElementById('livesDisplay').innerHTML=lives_html;
  document.getElementById('dodgeCount').textContent='â˜„ï¸ '+dodged+' dodged';
  document.getElementById('totalBig').textContent=score;
}

const EQ_SHOW=8; // how many terms to show
function addToEquation(val,color){
  eqNums.push({val,color});
  renderEquation();
}

function renderEquation(){
  const scroll=document.getElementById('equationScroll');
  const show=eqNums.slice(-EQ_SHOW);
  scroll.innerHTML=show.map((n,i)=>`
    ${i>0||eqNums.length>EQ_SHOW?`<span class="eq-plus">+</span>`:''}
    <span class="eq-num" style="color:${n.color};text-shadow:0 0 10px ${n.color};">${n.val}</span>
  `).join('');
  const total=document.getElementById('eqTotal');
  total.textContent='= '+score;
  // animate total
  total.style.animation='none';
  total.offsetHeight; // reflow
  total.style.animation='totalPulse .3s ease';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEVEL / SPEED / DENSITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LEVEL_ALERTS=[
  'âš¡ FASTER! âš¡',        // lv 2
  'âš¡ FASTER! âš¡',        // lv 3
  'ğŸ”¥ SPEED UP! ğŸ”¥',     // lv 4
  'ğŸ”¥ SPEED UP! ğŸ”¥',     // lv 5
  'ğŸ’¥ INTENSE! ğŸ’¥',      // lv 6
  'â˜„ï¸ METEOR STORM!',    // lv 7
  'ğŸŒªï¸ CHAOS MODE!',     // lv 8
  'ğŸ’€ DANGER ZONE!',     // lv 9
  'ğŸ”´ CRITICAL MASS!',   // lv 10
  'ğŸ‘¾ WARP SPEED!',      // lv 11
  'ğŸŒŒ SUPERNOVA!',       // lv 12
  'ğŸ¤¯ IMPOSSIBLE!',      // lv 13
  'â˜ ï¸ OBLIVION!',        // lv 14
  'ğŸ‘ï¸ THE VOID!',       // lv 15+
];

// SPEED: logarithmic curve â€” fast early gains, nearly flat after lv 7
// lv1=1.0, lv2=1.28, lv3=1.50, lv4=1.67, lv5=1.82, lv6=1.94, lv7=2.04, lv8=2.13, lv10=2.27, lv15=2.50
// Hard cap enforced in Asteroid constructor via MAX_VY
function speedForLevel(lv){
  return 1 + 1.6 * Math.log(lv) / Math.log(18); // log base 18 so lv18â‰ˆ2.6
}

// SPAWN INTERVAL: two independent components that combine
//   Level component: drives early game feel (fast levels feel faster)
//   Score component: exponential thresholds, each one shaves a little off
// The floor rises as speed slows so the game stays manageable
function calcSpawnInterval(){
  // Level component: shrinks quickly early, plateaus around lv 7-8
  // lv1=110, lv4=83, lv7=65, lv10=56, lv14=52 (floor 50)
  const fromLevel=Math.max(50, Math.round(110 - level*4.5 - Math.sqrt(level)*3));

  // Score component: exponential thresholds 50â†’90â†’162â†’292â†’525â†’945â†’1701...
  // Each tier shaves 4 frames, max 7 tiers = -28 frames total (slow burn)
  let densityBonus=0, thresh=50;
  while(score>=thresh && densityBonus<7){
    densityBonus++;
    thresh=Math.floor(thresh*1.8);
  }

  // At high speed (lv7+), raise the floor so its density not impossible speed
  const floor=level>=7?22:16;
  return Math.max(floor, fromLevel - densityBonus*4);
}

// How many extra asteroids to spawn in a burst (based on score milestones)
function extraAsteroids(){
  let thresh=50, count=0;
  while(score>=thresh && count<5){
    count++;
    thresh=Math.floor(thresh*1.8);
  }
  // Stagger: return count but cap at 4 extras per spawn event
  return Math.min(count, 4);
}

let lastDensityThreshold=0;
function checkDensityMilestone(){
  let thresh=50, tier=0;
  while(score>=thresh){ tier++; thresh=Math.floor(thresh*1.8); }
  if(tier>lastDensityThreshold){
    lastDensityThreshold=tier;
    // No flash here â€” just silently increase density
  }
}

function checkLevel(){
  // Level display: every 12 dodges. Purely cosmetic badge + alert after lv 6.
  // The badge keeps counting but mechanics decouple â€” speed is log, density is score.
  const newLevel=Math.floor(dodged/12)+1;
  if(newLevel>level){
    level=newLevel;
    // Speed: log curve â€” front-loaded, nearly flat by lv 7+
    speedMult=speedForLevel(level);
    // Spawn interval: recalculate (also affected by score via calcSpawnInterval)
    spawnInterval=calcSpawnInterval();
    const alertTxt=LEVEL_ALERTS[Math.min(level-2, LEVEL_ALERTS.length-1)];
    const alert=document.getElementById('speedAlert');
    alert.textContent=alertTxt;
    alert.className='show';
    setTimeout(()=>alert.className='',1800);
  } else {
    // Even without a level-up, recalculate interval as score climbs
    spawnInterval=calcSpawnInterval();
    checkDensityMilestone();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POPUP FLOATER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPopup(x,y,text,color){
  const el=document.createElement('div');
  el.className='combo-popup';
  el.textContent=text;
  el.style.cssText=`left:${x}px;top:${y}px;color:${color};font-size:${text.length>3?'1.1rem':'1.4rem'};`;
  wrap.appendChild(el);
  setTimeout(()=>el.remove(),850);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLLISION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkCollisions(){
  const sx=ship.x, sy=ship.y;
  // Tight FIXED hitbox â€” same size regardless of asteroid size
  const hw=18, hh=22;

  for(const a of asteroids){
    if(a.dodged||a.hit) continue;

    // DODGE FIRST: asteroid bottom edge has fully passed below the ship bottom
    // Do this before hit check so large asteroids that fly past always score
    if(a.y - a.r > sy + hh){
      a.dodged=true;
      score+=a.val;
      dodged++;
      addToEquation(a.val,a.color);
      spawnParticles(a.x, a.y-a.r, a.color, 8, 'dodge');
      showPopup(a.x-20, a.y-a.r-30, '+'+a.val, a.color);
      checkLevel();
      updateHUD();
      continue;
    }

    // Off screen without scoring
    if(a.y > H+80){ a.dodged=true; continue; }

    // CLOSE CALL: passed nearby without hitting â€” reward with feedback
    if(!a.closeCalled && a.y > sy-hh-a.r && a.y < sy+hh+a.r){
      const dx2=Math.abs(a.x-sx);
      if(dx2 > hw+Math.min(a.r*0.38,18) && dx2 < hw+a.r*0.9){
        a.closeCalled=true;
        showPopup(sx, sy-50, 'ğŸ˜¬ CLOSE!', '#FFD93D');
      }
    }

    // HIT: fixed small collision radius regardless of asteroid visual size
    const dx=Math.abs(a.x-sx), dy=Math.abs(a.y-sy);
    const hitR=Math.min(a.r*0.38, 18);
    if(dx < hw+hitR && dy < hh+hitR){
      a.hit=true;
      lives--;
      shipFlash=20;
      spawnParticles(a.x,a.y,'#ff4444',18,'explode');
      spawnParticles(sx,sy,'#ff8888',10,'explode');
      // Red screen flash on hit
      const hitFlash=document.createElement('div');
      hitFlash.style.cssText='position:fixed;inset:0;background:rgba(255,0,0,.28);pointer-events:none;z-index:19;animation:lvlF .45s ease forwards;';
      document.body.appendChild(hitFlash);
      setTimeout(()=>hitFlash.remove(),500);
      updateHUD();
      if(lives<=0) setTimeout(()=>endGame(),400);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPAWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnAsteroid(){
  // avoid spawning directly on ship
  let attempts=0, a;
  do{
    a=new Asteroid();
    attempts++;
  }while(Math.abs(a.x-ship.x)<60 && attempts<5);
  asteroids.push(a);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gameLoop(){
  if(!gameActive) return;

  ctx.clearRect(0,0,W,H);

  // Move ship toward pointer
  if(pointerX!==null){
    const target=Math.max(ship.w*.6,Math.min(W-ship.w*.6,pointerX));
    ship.vx=(target-ship.x)*.18;
  } else {
    ship.vx*=.85;
  }
  ship.x+=ship.vx;
  ship.x=Math.max(ship.w*.6,Math.min(W-ship.w*.6,ship.x));

  // Spawn â€” base + score-driven density, stagger extras
  spawnTimer++;
  if(spawnTimer>=spawnInterval){
    spawnTimer=0;
    spawnAsteroid();
    const extra=extraAsteroids();
    for(let i=0;i<extra;i++){
      // Stagger extras by 80-200ms so they dont spawn as one clump
      const delay=80+i*Math.floor(60+Math.random()*60);
      setTimeout(()=>{ if(gameActive) spawnAsteroid(); }, delay);
    }
  }

  // Update & draw asteroids
  asteroids=asteroids.filter(a=>a.y<H+80 && !a.hit);
  for(const a of asteroids){
    a.update();
    a.draw();
  }

  // Collisions
  checkCollisions();

  // Particles
  updateParticles();
  drawParticles();

  // Ship
  drawShip(ship.x,ship.y,shipFlash>0);
  if(shipFlash>0) shipFlash--;

  // Scrolling star bg (parallax)
  // (stars handled by CSS; just leave canvas clear on bottom)

  animId=requestAnimationFrame(gameLoop);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START / END
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(){
  document.getElementById('startScreen').classList.add('hidden');
  document.getElementById('gameOverScreen').classList.add('hidden');

  ship.x=W/2; ship.y=H-100; ship.vx=0;
  asteroids=[]; particles=[];
  lives=3; score=0; dodged=0; level=1; speedMult=1;
  spawnTimer=0; spawnInterval=120; baseSpeed=2.5;
  lastDensityThreshold=0;
  eqNums=[];
  shipFlash=0;
  pointerX=null;

  document.getElementById('equationScroll').innerHTML='';
  document.getElementById('eqTotal').textContent='= 0';
  updateHUD();

  gameActive=true; gameOver=false;
  if(animId) cancelAnimationFrame(animId);
  gameLoop();
}
window.startGame=startGame;

function endGame(){
  gameActive=false;
  if(animId) cancelAnimationFrame(animId);
  if(score>bestScore) bestScore=score;

  document.getElementById('goTotal').textContent=score;
  document.getElementById('goDodged').textContent=dodged;
  document.getElementById('goBest').textContent=bestScore;

  // show last equation â€” truncate to last 20 terms to avoid overflow
  const showNums=eqNums.length>20?eqNums.slice(-20):eqNums;
  const prefix=eqNums.length>20?'... + ':'';
  const eqStr=prefix+showNums.map(n=>n.val).join(' + ')+(showNums.length?' = '+score:'');
  document.getElementById('goEquation').textContent=eqStr||'No asteroids dodged yet!';

  document.getElementById('gameOverScreen').classList.remove('hidden');
}

function showStart(){
  gameActive=false;
  if(animId) cancelAnimationFrame(animId);
  document.getElementById('gameOverScreen').classList.add('hidden');
  document.getElementById('startScreen').classList.remove('hidden');
}
window.showStart=showStart;

// Init
resize();
</script>
</body>
</html>
